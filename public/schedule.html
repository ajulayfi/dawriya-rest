<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø¯ÙˆØ±ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© â€” Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±</title>

  <link rel="stylesheet" href="./assets/app.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .cardsGrid{display:grid;gap:12px}
    .actionsCol{display:flex;flex-direction:column;gap:8px;min-width:180px}
    @media (max-width:720px){.actionsCol{min-width:unset}}
    .mealCard{border:1px solid var(--line,#e5e7eb);border-radius:16px;background:#fff;padding:12px}
    .mealTop{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .mealBadge{display:inline-flex;align-items:center;gap:8px;font-weight:800}
    .mealMeta{margin-top:8px;color:var(--muted,#64748b);font-size:13px;line-height:1.6}
    .hostsBlock{margin-top:10px;padding-top:10px;border-top:1px dashed var(--line,#e5e7eb)}
    .hostsTitle{font-weight:800;margin-bottom:4px}
    .hostsNames{color:#0f172a;font-weight:700}
    .notice{padding:10px 12px;border-radius:14px;background:#fff;border:1px solid var(--line,#e5e7eb)}
    .notice.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.06)}
    .notice.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.06)}
    .stickyBar{position:sticky;top:0;background:rgba(248,250,252,.92);backdrop-filter:blur(8px);border:1px solid var(--line,#e5e7eb);border-radius:16px;padding:10px 12px;margin-top:12px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line,#e5e7eb);background:#fff;font-size:12px;color:var(--muted,#64748b)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;background:#111827;color:#fff}
    .btn.secondary{background:#fff;color:#111827;border:1px solid var(--line,#e5e7eb)}
    .input{border:1px solid var(--line,#e5e7eb);border-radius:12px;padding:10px 12px;background:#fff}
    .sub{color:var(--muted,#64748b)}
  </style>
</head>

<body>
<div class="container">

  <div class="header">
    <div class="title">
      <h1 id="pageTitle">Ø¯ÙˆØ±ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</h1>
      <div class="sub">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±ÙŠ â€” Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙ‚ÙˆÙŠÙ… Ø£Ùˆ Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</div>
    </div>
    <div class="toolbar">
      <a class="btn secondary" href="./login.html">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
    </div>
  </div>

  <div class="stickyBar">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <span class="badge" id="monthBadge">â€”</span>
      <span class="badge">ğŸ“ <b style="color:#111827" id="loc">Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</b></span>
      <span class="badge" id="accessBadge" style="display:none">ğŸ”’ Ø±Ø§Ø¨Ø· Ø®Ø§Øµ</span>
    </div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <input id="monthPick" class="input" type="month" style="width:160px"/>
      <button id="reload" class="btn secondary">ØªØ­Ø¯ÙŠØ«</button>
    </div>
  </div>

  <div id="msg" class="notice">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„â€¦</div>
  <div id="list" style="margin-top:12px">â€”</div>

</div>

<script type="module">
  import { SUPABASE_URL, SUPABASE_ANON_KEY, ACCESS_TOKEN, TZ, DEFAULT_LOCATION, APP_TITLE } from "./assets/config.js";

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  window.sb = sb; // Ù„Ù„ØªØ´Ø®ÙŠØµ

  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2,"0");

  $("pageTitle").textContent = APP_TITLE;
  $("loc").textContent = DEFAULT_LOCATION;

  function setMessage(kind, text){
    $("msg").className = kind ? ("notice " + kind) : "notice";
    $("msg").textContent = text;
  }

  function getMonthParam(){
    const u = new URL(location.href);
    const m = u.searchParams.get("month");
    if (m && /^\d{4}-\d{2}$/.test(m)) return m;
    const d = new Date();
    return d.getFullYear() + "-" + pad2(d.getMonth()+1);
  }

  function monthLabel(month){
    const [y, m] = month.split("-").map(Number);
    const d = new Date(Date.UTC(y, m-1, 1, 12, 0, 0));
    return new Intl.DateTimeFormat("ar-SA", { year:"numeric", month:"long", timeZone: TZ }).format(d);
  }

  function mealLabel(key){
    return ({ futoor:"ÙØ·ÙˆØ±", ghada:"ØºØ¯Ø§", asha:"Ø¹Ø´Ø§", suhoor:"Ø³Ø­ÙˆØ±" }[key] || key);
  }

  function fmtGregorian(iso){
    const d = new Date(iso);
    const weekday = new Intl.DateTimeFormat("ar-SA", { weekday:"long", timeZone: TZ }).format(d);
    const ymd = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" }).format(d);
    const [y, m, da] = ymd.split("-");
    return `${weekday} ${da}/${m}/${y}`;
  }

  function fmtHijri(iso){
    const d = new Date(iso);
    try{
      const h = new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura", { year:"numeric", month:"long", day:"numeric", timeZone: TZ }).format(d);
      return "Ø§Ù„Ù…ÙˆØ§ÙÙ‚ " + h;
    }catch(e){
      return "Ø§Ù„Ù…ÙˆØ§ÙÙ‚ â€”";
    }
  }

  function fmtTime12(iso){
    const d = new Date(iso);
    return new Intl.DateTimeFormat("ar-SA", { hour:"numeric", minute:"2-digit", hour12:true, timeZone: TZ }).format(d);
  }

  function makeICS({ title, description, location, startsAtISO, endsAtISO }){
    const dt = (date) => {
      const y=date.getUTCFullYear();
      const mo=pad2(date.getUTCMonth()+1);
      const da=pad2(date.getUTCDate());
      const hh=pad2(date.getUTCHours());
      const mm=pad2(date.getUTCMinutes());
      const ss=pad2(date.getUTCSeconds());
      return `${y}${mo}${da}T${hh}${mm}${ss}Z`;
    };
    const esc = (s) => String(s||"")
      .replace(/\\/g,"\\\\")
      .replace(/\n/g,"\\n")
      .replace(/,/g,"\\,")
      .replace(/;/g,"\\;");

    const uid = (crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"")) + "@dawriya-rest";

    return [
      "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Dawriya Rest//AR//EN","CALSCALE:GREGORIAN","METHOD:PUBLISH",
      "BEGIN:VEVENT",
      "UID:" + uid,
      "DTSTAMP:" + dt(new Date()),
      "DTSTART:" + dt(new Date(startsAtISO)),
      "DTEND:" + dt(new Date(endsAtISO)),
      "SUMMARY:" + esc(title),
      "DESCRIPTION:" + esc(description),
      "LOCATION:" + esc(location),
      "END:VEVENT",
      "END:VCALENDAR"
    ].join("\\r\\n");
  }

  function downloadICS(text, filename){
    const blob = new Blob([text], { type:"text/calendar;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 1200);
  }

  function waShare(text){
    window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
  }

  function buildCard(r){
    const hosts = (r._hostNames?.length ? r._hostNames.join(" â€“ ") : "â€”");
    const g = fmtGregorian(r.starts_at);
    const h = fmtHijri(r.starts_at);
    const t = `${fmtTime12(r.starts_at)} â€“ ${fmtTime12(r.ends_at)}`;

    const card = document.createElement("div");
    card.className = "mealCard";

    const top = document.createElement("div");
    top.className = "mealTop";

    const left = document.createElement("div");

    const badge = document.createElement("div");
    badge.className = "mealBadge";
    badge.textContent = "ğŸ½ï¸ " + mealLabel(r.meal);

    const meta = document.createElement("div");
    meta.className = "mealMeta";
    meta.innerHTML = `ğŸ“… <b style="color:#0f172a">${g}</b><br>ğŸ•Œ ${h}<br>â° ${t}`;

    left.appendChild(badge);
    left.appendChild(meta);

    const actions = document.createElement("div");
    actions.className = "actionsCol";

    const btnIcs = document.createElement("button");
    btnIcs.className = "btn secondary";
    btnIcs.textContent = "ğŸ“… Ø£Ø¶Ù Ù„Ù„ØªÙ‚ÙˆÙŠÙ…";
    btnIcs.onclick = () => {
      const title = `${APP_TITLE} â€” ${mealLabel(r.meal)}`;
      const desc = [
        `ğŸ½ï¸ ${mealLabel(r.meal)}`,
        `ğŸ“… ${g}`,
        `ğŸ•Œ ${h}`,
        `â° ${t}`,
        `ğŸ“ ${DEFAULT_LOCATION}`,
        `ğŸ‘¥ Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†: ${hosts}`,
        r.notes ? `ğŸ“ ${r.notes}` : null
      ].filter(Boolean).join("\n");

      const ics = makeICS({
        title,
        description: desc,
        location: DEFAULT_LOCATION,
        startsAtISO: r.starts_at,
        endsAtISO: r.ends_at
      });

      const ymd = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" }).format(new Date(r.starts_at));
      downloadICS(ics, `${APP_TITLE}-${mealLabel(r.meal)}-${ymd}.ics`);
    };

    const btnWa = document.createElement("button");
    btnWa.className = "btn";
    btnWa.textContent = "ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨";
    btnWa.onclick = () => {
      const msg = [
        `ğŸ½ï¸ ${mealLabel(r.meal)}`,
        `ğŸ“… ${g}`,
        `ğŸ•Œ ${h}`,
        `â° ${t}`,
        `ğŸ“ ${DEFAULT_LOCATION}`,
        `ğŸ‘¥ Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†: ${hosts}`,
        r.notes ? `ğŸ“ ${r.notes}` : null,
        "",
        location.href
      ].filter(Boolean).join("\n");
      waShare(msg);
    };

    actions.appendChild(btnIcs);
    actions.appendChild(btnWa);

    top.appendChild(left);
    top.appendChild(actions);

    const hostsBlock = document.createElement("div");
    hostsBlock.className = "hostsBlock";

    const ht = document.createElement("div");
    ht.className = "hostsTitle";
    ht.textContent = "Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†";

    const hn = document.createElement("div");
    hn.className = "hostsNames";
    hn.textContent = hosts;

    hostsBlock.appendChild(ht);
    hostsBlock.appendChild(hn);

    if (r.notes){
      const note = document.createElement("div");
      note.className = "sub";
      note.style.marginTop = "6px";
      note.textContent = "Ù…Ù„Ø§Ø­Ø¸Ø©: " + r.notes;
      hostsBlock.appendChild(note);
    }

    card.appendChild(top);
    card.appendChild(hostsBlock);

    return card;
  }

  function requireAccessIfProvided(){
    const u = new URL(location.href);
    const access = u.searchParams.get("access");
    if (!access) return true; // Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠÙ‡ access Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø§ Ù†Ù‚ÙÙ„ (ØµÙØ­Ø© Ø¹Ø§Ù…Ø©)
    $("accessBadge").style.display = "inline-flex";
    return access === ACCESS_TOKEN;
  }

  async function loadMonth(month){
    $("monthBadge").textContent = monthLabel(month);
    setMessage("", "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„â€¦");
    $("list").textContent = "â€”";

    if (!requireAccessIfProvided()){
      setMessage("warn", "Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ (access).");
      $("list").innerHTML = "";
      return;
    }

    // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ù‡Ø± (Ø¨Ø§Ù„Ø±ÙŠØ§Ø¶)
    const start = `${month}-01T00:00:00+03:00`;
    const [yy, mm] = month.split("-").map(Number);
    const endDate = new Date(Date.UTC(yy, mm, 1, 0,0,0)); // Ø£ÙˆÙ„ ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„ØªØ§Ù„ÙŠ UTC
    const end = `${endDate.getUTCFullYear()}-${pad2(endDate.getUTCMonth()+1)}-${pad2(endDate.getUTCDate())}T00:00:00+03:00`;

    const res = await sb
      .from("meals")
      .select(`
        id, meal, starts_at, ends_at, notes,
        meal_hosts (
          member_id,
          members ( full_name )
        )
      `)
      .gte("starts_at", start)
      .lt("starts_at", end)
      .order("starts_at", { ascending:true });

    console.log("meals res:", res);

    if (res.error){
      setMessage("warn", "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + res.error.message);
      $("list").innerHTML = "";
      return;
    }

    const rows = res.data || [];
    if (!rows.length){
      setMessage("", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.");
      $("list").innerHTML = `<div class="notice">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø§Øª.</div>`;
      return;
    }

    // Ø¨Ù†Ø§Ø¡ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†
    rows.forEach(r => {
      const names = (r.meal_hosts || [])
        .map(h => h.members?.full_name)
        .filter(Boolean);
      r._hostNames = names;
    });

    setMessage("ok", "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„.");
    const wrap = document.createElement("div");
    wrap.className = "cardsGrid";
    rows.forEach(r => wrap.appendChild(buildCard(r)));

    $("list").innerHTML = "";
    $("list").appendChild(wrap);
  }

  // Init
  const initialMonth = getMonthParam();
  $("monthPick").value = initialMonth;
  $("monthBadge").textContent = monthLabel(initialMonth);

  $("reload").addEventListener("click", () => loadMonth($("monthPick").value));
  $("monthPick").addEventListener("change", () => loadMonth($("monthPick").value));

  loadMonth(initialMonth);
</script>

</body>
</html>