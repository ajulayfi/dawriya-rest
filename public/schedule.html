<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø¯ÙˆØ±ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© â€” Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±</title>
  <link rel="stylesheet" href="./assets/app.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">
      <h1 id="pageTitle">Ø¯ÙˆØ±ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</h1>
      <div class="sub" id="pageSub">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø± â€” Ø§Ø¶ØºØ· â€œØ£Ø¶Ù Ù„Ù„ØªÙ‚ÙˆÙŠÙ…â€ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ÙÙŠ ØªÙ‚ÙˆÙŠÙ…Ùƒ</div>
    </div>
    <div class="toolbar">
      <a class="btn secondary" href="./login.html">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
    </div>
  </div>

  <div id="nextBox" class="nextBanner" style="display:none"></div>

  <div class="stickyBar">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <span class="badge" id="monthBadge">â€”</span>
      <span class="badge">ğŸ“ <b style="color:#111827" id="loc">Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</b></span>
    </div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <input id="monthPick" class="input" type="month" style="width:160px"/>
      <button id="reload" class="btn secondary">ØªØ­Ø¯ÙŠØ«</button>
    </div>

    <div class="chips" id="chips">
      <button class="chip active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
      <button class="chip" data-filter="futoor">ÙØ·ÙˆØ±</button>
      <button class="chip" data-filter="ghada">ØºØ¯Ø§</button>
      <button class="chip" data-filter="asha">Ø¹Ø´Ø§</button>
      <button class="chip" data-filter="suhoor">Ø³Ø­ÙˆØ±</button>
    </div>
  </div>

  <div id="msg" class="notice">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„â€¦</div>

  <div class="card" style="margin-top:12px">
    <div style="font-weight:800">Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div>
    <div class="small">ØªØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±.</div>
    <div class="hr"></div>
    <div id="list">â€”</div>
  </div>
</div>

<script type="module">
  import { SUPABASE_URL, SUPABASE_ANON_KEY, APP_TITLE, DEFAULT_LOCATION, TZ } from "./assets/config.js";

  const $ = (id) => document.getElementById(id);
  const pad2 = (n)=>String(n).padStart(2,"0");

  function getMonthParam(){
    const u = new URL(location.href);
    const m = u.searchParams.get("month");
    if (m && /^\d{4}-\d{2}$/.test(m)) return m;
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  }

  function monthLabel(month){
    const [y,m]=month.split("-").map(Number);
    const d = new Date(Date.UTC(y,m-1,1));
    return new Intl.DateTimeFormat("ar-SA", { year:"numeric", month:"long", timeZone: TZ }).format(d);
  }

  function formatGregorian(iso){
    const d = new Date(iso);
    return new Intl.DateTimeFormat("ar-SA", { weekday:"long", year:"numeric", month:"long", day:"numeric", timeZone: TZ }).format(d);
  }

  function formatHijriUmmAlQura(iso){
    const d = new Date(iso);
    try{
      return new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura", { year:"numeric", month:"long", day:"numeric", timeZone: TZ }).format(d);
    }catch{
      return "â€”";
    }
  }

  function formatTime12(iso){
    const d = new Date(iso);
    return new Intl.DateTimeFormat("ar-SA", { hour:"numeric", minute:"2-digit", hour12:true, timeZone: TZ }).format(d);
  }

  function mealLabel(key){
    return ({ futoor:"ÙØ·ÙˆØ±", ghada:"ØºØ¯Ø§", asha:"Ø¹Ø´Ø§", suhoor:"Ø³Ø­ÙˆØ±" }[key] || key);
  }

  function makeIcs({ title, description, location, start, end }){
    const dt = (d) => {
      const y=d.getUTCFullYear(), mo=pad2(d.getUTCMonth()+1), da=pad2(d.getUTCDate());
      const hh=pad2(d.getUTCHours()), mm=pad2(d.getUTCMinutes()), ss=pad2(d.getUTCSeconds());
      return `${y}${mo}${da}T${hh}${mm}${ss}Z`;
    };
    const esc = (s) => String(s||"")
      .replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;");
    const uid = `${crypto.randomUUID()}@dawriya-rest`;
    const now = dt(new Date());

    return [
      "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Dawriya Rest//AR//EN","CALSCALE:GREGORIAN","METHOD:PUBLISH",
      "BEGIN:VEVENT",
      `UID:${uid}`,
      `DTSTAMP:${now}`,
      `DTSTART:${dt(start)}`,
      `DTEND:${dt(end)}`,
      `SUMMARY:${esc(title)}`,
      `DESCRIPTION:${esc(description)}`,
      `LOCATION:${esc(location)}`,
      "END:VEVENT","END:VCALENDAR"
    ].join("\r\n");
  }

  function downloadIcs(icsText, filename){
    const blob = new Blob([icsText], { type:"text/calendar;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  }

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // UI init
  document.title = `${APP_TITLE} â€” Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±`;
  $("pageTitle").textContent = APP_TITLE;
  $("loc").textContent = DEFAULT_LOCATION;

  let activeFilter = "all";
  let cachedRows = [];

  function setMessage(kind, text){
    $("msg").className = kind ? `notice ${kind}` : "notice";
    $("msg").textContent = text;
  }

  function setFilter(f){
    activeFilter = f;
    document.querySelectorAll(".chip").forEach(c => c.classList.toggle("active", c.dataset.filter === f));
    renderCards();
  }

  document.getElementById("chips").addEventListener("click", (e) => {
    const btn = e.target.closest(".chip");
    if (!btn) return;
    setFilter(btn.dataset.filter);
  });

  $("reload").addEventListener("click", ()=>loadMonth($("monthPick").value));
  $("monthPick").addEventListener("change", ()=>loadMonth($("monthPick").value));

  function pickNextUpcoming(rows){
    const now = new Date();
    const upcoming = rows
      .filter(r => new Date(r.starts_at) >= now)
      .sort((a,b)=> new Date(a.starts_at) - new Date(b.starts_at));
    return upcoming[0] || null;
  }

  function showNextBanner(r){
    const box = $("nextBox");
    if (!r){ box.style.display="none"; return; }

    box.style.display="block";
    box.innerHTML = `
      â­ï¸ <b>Ø£Ù‚Ø±Ø¨ Ù…Ù†Ø§Ø³Ø¨Ø©:</b> ${mealLabel(r.meal)} â€” ${formatGregorian(r.starts_at)}
      <div style="margin-top:6px" class="small">
        â° ${formatTime12(r.starts_at)} â€“ ${formatTime12(r.ends_at)}
      </div>
    `;
  }

  function renderCards(){
    let rows = cachedRows.slice();
    if (activeFilter !== "all") rows = rows.filter(r => r.meal === activeFilter);

    if (!rows.length){
      $("list").innerHTML = `<div class="notice">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ÙÙ„ØªØ±.</div>`;
      return;
    }

    const wrap = document.createElement("div");
    wrap.className = "cardsGrid";

    for (const r of rows){
      const hostNames = (r._hostNames || []);
      const hostsText = hostNames.length ? hostNames.join(" â€“ ") : "â€”";

      const title = `${APP_TITLE} â€” ${mealLabel(r.meal)}`;
      const desc =
`${mealLabel(r.meal)}
Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†: ${hostsText}
${r.notes ? ("Ù…Ù„Ø§Ø­Ø¸Ø©: " + r.notes) : ""}`.trim();

      const startD = new Date(r.starts_at);
      const endD = new Date(r.ends_at);

      const card = document.createElement("div");
      card.className = "card mealCard mealCardPro";
      card.dataset.meal = r.meal;

      const top = document.createElement("div");
      top.className = "mealTopPro";

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="mealBadge">ğŸ½ï¸ ${mealLabel(r.meal)}</div>
        <div style="height:8px"></div>
        <div class="mealMeta">
          <div><b style="color:#0f172a">${formatGregorian(r.starts_at)}</b></div>
          <div>${formatHijriUmmAlQura(r.starts_at)}</div>
          <div>â° ${formatTime12(r.starts_at)} â€“ ${formatTime12(r.ends_at)}</div>
        </div>
      `;

      const btn = document.createElement("button");
      btn.className = "btn secondary primaryAction";
      btn.textContent = "ğŸ“… Ø£Ø¶Ù Ù„Ù„ØªÙ‚ÙˆÙŠÙ…";
      btn.addEventListener("click", () => {
        const ics = makeIcs({
          title,
          description: desc,
          location: DEFAULT_LOCATION,
          start: startD,
          end: endD
        });
        const ymd = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" }).format(new Date(r.starts_at));
        downloadIcs(ics, `${APP_TITLE}-${mealLabel(r.meal)}-${ymd}.ics`);
      });

      top.appendChild(left);
      top.appendChild(btn);

      const hosts = document.createElement("div");
      hosts.className = "hostsBlock";
      hosts.innerHTML = `
        <div class="hostsTitle">Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†</div>
        <div class="hostsNames">${hostsText}</div>
        ${r.notes ? `<div class="small" style="margin-top:8px">Ù…Ù„Ø§Ø­Ø¸Ø©: ${r.notes}</div>` : ``}
      `;

      card.appendChild(top);
      card.appendChild(hosts);

      wrap.appendChild(card);
    }

    $("list").innerHTML="";
    $("list").appendChild(wrap);
  }

  async function loadMonth(m){
    $("monthBadge").textContent = monthLabel(m);
    $("monthPick").value = m;
    setMessage("", "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„â€¦");
    $("list").textContent = "â€”";

    const start = `${m}-01T00:00:00+03:00`;
    const [yy, mm] = m.split("-").map(Number);
    const endDate = new Date(Date.UTC(yy, mm, 1, 0, 0, 0));
    const end = `${endDate.getUTCFullYear()}-${pad2(endDate.getUTCMonth()+1)}-${pad2(endDate.getUTCDate())}T00:00:00+03:00`;

    // 1) meals
    const { data: meals, error: e1 } = await supabase
      .from("meals")
      .select("id, meal, starts_at, ends_at, notes")
      .gte("starts_at", start)
      .lt("starts_at", end)
      .order("starts_at", { ascending:true });

    if (e1){
      setMessage("warn", `ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e1.message}`);
      $("list").textContent="â€”";
      showNextBanner(null);
      return;
    }

    const rows = meals || [];
    if (!rows.length){
      setMessage("", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.");
      $("list").innerHTML = `<div class="notice">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø§Øª.</div>`;
      showNextBanner(null);
      cachedRows = [];
      return;
    }

    // 2) load hosts names (robust)
    const mealIds = rows.map(r=>r.id);
    const { data: links, error: e2 } = await supabase
      .from("meal_hosts")
      .select("meal_id, member_id")
      .in("meal_id", mealIds);

    if (e2){
      setMessage("warn", `ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†: ${e2.message}`);
      showNextBanner(pickNextUpcoming(rows));
      cachedRows = rows;
      cachedRows.forEach(r=>r._hostNames=[]);
      renderCards();
      return;
    }

    const memberIds = [...new Set((links||[]).map(x=>x.member_id))];
    const membersMap = new Map();

    if (memberIds.length){
      const { data: mems, error: e3 } = await supabase
        .from("members")
        .select("id, full_name")
        .in("id", memberIds);

      if (!e3){
        (mems||[]).forEach(m=>membersMap.set(m.id, m.full_name));
      }
    }

    const hostsByMeal = new Map();
    (links||[]).forEach(l=>{
      if (!hostsByMeal.has(l.meal_id)) hostsByMeal.set(l.meal_id, []);
      hostsByMeal.get(l.meal_id).push(membersMap.get(l.member_id) || "â€”");
    });

    rows.forEach(r => {
      r._hostNames = (hostsByMeal.get(r.id) || []).filter(Boolean);
    });

    cachedRows = rows;
    setMessage("ok", "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„.");
    showNextBanner(pickNextUpcoming(rows));
    renderCards();
  }

  const initialMonth = getMonthParam();
  loadMonth(initialMonth);
</script>
</body>
</html>
