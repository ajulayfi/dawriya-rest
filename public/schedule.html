<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>دورية الاستراحة</title>
<link rel="stylesheet" href="./assets/app.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<div class="container">

<h1 style="margin-bottom:8px">دورية الاستراحة</h1>
<div id="nextBox" class="notice ok" style="display:none"></div>
<div id="list" style="margin-top:20px"></div>

</div>

<script type="module">

import { SUPABASE_URL, SUPABASE_ANON_KEY, APP_TITLE, DEFAULT_LOCATION, TZ } from "./assets/config.js";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const list = document.getElementById("list");
const nextBox = document.getElementById("nextBox");

function formatDate(iso){
  const d = new Date(iso);
  return new Intl.DateTimeFormat("ar-SA", {
    weekday:"long",
    year:"numeric",
    month:"2-digit",
    day:"2-digit",
    hour:"numeric",
    minute:"2-digit",
    hour12:true,
    timeZone:TZ
  }).format(d);
}

function isToday(iso){
  const a = new Intl.DateTimeFormat("en-CA",{timeZone:TZ,year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date(iso));
  const b = new Intl.DateTimeFormat("en-CA",{timeZone:TZ,year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date());
  return a===b;
}

function countdownText(target){
  const diff = new Date(target) - new Date();
  if(diff<=0) return "بدأت الآن";
  const minutes = Math.floor(diff/60000);
  const hours = Math.floor(minutes/60);
  const days = Math.floor(hours/24);
  if(days>0) return "باقي "+days+" يوم";
  if(hours>0) return "باقي "+hours+" ساعة";
  return "باقي "+minutes+" دقيقة";
}

async function load(){

  const {data, error} = await supabase
  .from("meals")
  .select("*")
  .order("starts_at",{ascending:true});

  if(error){
    list.innerHTML="خطأ: "+error.message;
    return;
  }

  if(!data.length){
    list.innerHTML="لا توجد مناسبات";
    return;
  }

  const now = new Date();
  const upcoming = data.filter(x=>new Date(x.starts_at)>=now)[0];

  if(upcoming){
    nextBox.style.display="block";
    nextBox.innerHTML="⏭️ أقرب مناسبة: "
    + upcoming.meal
    + "<br>"
    + formatDate(upcoming.starts_at)
    + "<br><b>"
    + countdownText(upcoming.starts_at)
    + "</b>";
  }

  list.innerHTML="";

  data.forEach(r=>{
    const card=document.createElement("div");
    card.className="card";
    card.style.marginBottom="15px";

    if(new Date(r.starts_at)<now){
      card.style.opacity="0.4";
    }

    if(isToday(r.starts_at)){
      card.style.border="2px solid orange";
    }

    card.innerHTML=
    "<b>"+r.meal+"</b><br>"
    + formatDate(r.starts_at);

    list.appendChild(card);
  });

}

load();

</script>

</body>
</html>
