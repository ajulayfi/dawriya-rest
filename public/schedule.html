<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø¯ÙˆØ±ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© â€” Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±</title>
  <link rel="stylesheet" href="./assets/app.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">
      <h1 id="pageTitle">Ø¯ÙˆØ±ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</h1>
      <div class="sub">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø± â€” Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙ‚ÙˆÙŠÙ… Ø£Ùˆ Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</div>
    </div>
    <div class="toolbar">
      <a class="btn secondary" href="./login.html">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
    </div>
  </div>

  <div id="msg" class="notice">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„â€¦</div>

  <div class="card" style="margin-top:12px">
    <div style="font-weight:800">Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div>
    <div class="small">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„ØªÙ‚ÙˆÙŠÙ… Ø£Ùˆ Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.</div>
    <div class="hr"></div>
    <div id="list">â€”</div>
  </div>
</div>

<script type="module">
import { SUPABASE_URL, SUPABASE_ANON_KEY, APP_TITLE, DEFAULT_LOCATION, TZ } from "./assets/config.js";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $ = (id)=>document.getElementById(id);
const pad2 = (n)=>String(n).padStart(2,"0");

function mealLabel(key){
  return ({ futoor:"ÙØ·ÙˆØ±", ghada:"ØºØ¯Ø§", asha:"Ø¹Ø´Ø§", suhoor:"Ø³Ø­ÙˆØ±" }[key] || key);
}

function formatGregorian(iso){
  const d = new Date(iso);
  const weekday = new Intl.DateTimeFormat("ar-SA",{weekday:"long",timeZone:TZ}).format(d);
  const ymd = new Intl.DateTimeFormat("en-CA",{timeZone:TZ,year:"numeric",month:"2-digit",day:"2-digit"}).format(d);
  const [y,m,da] = ymd.split("-");
  return `${weekday} ${da}/${m}/${y}`;
}

function formatHijri(iso){
  const d = new Date(iso);
  try{
    const h = new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura",{year:"numeric",month:"long",day:"numeric",timeZone:TZ}).format(d);
    return `Ø§Ù„Ù…ÙˆØ§ÙÙ‚ ${h}`;
  }catch{
    return "";
  }
}

function formatTime(iso){
  const d = new Date(iso);
  return new Intl.DateTimeFormat("ar-SA",{hour:"numeric",minute:"2-digit",hour12:true,timeZone:TZ}).format(d);
}

function makeIcs({ title, description, location, start, end }){
  const dt = (d)=>{
    const y=d.getUTCFullYear(),mo=pad2(d.getUTCMonth()+1),da=pad2(d.getUTCDate());
    const hh=pad2(d.getUTCHours()),mm=pad2(d.getUTCMinutes()),ss=pad2(d.getUTCSeconds());
    return `${y}${mo}${da}T${hh}${mm}${ss}Z`;
  };
  const uid = crypto.randomUUID()+"@dawriya";
  return [
    "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Dawriya//AR//",
    "BEGIN:VEVENT",
    `UID:${uid}`,
    `DTSTAMP:${dt(new Date())}`,
    `DTSTART:${dt(start)}`,
    `DTEND:${dt(end)}`,
    `SUMMARY:${title}`,
    `DESCRIPTION:${description}`,
    `LOCATION:${location}`,
    "END:VEVENT","END:VCALENDAR"
  ].join("\r\n");
}

function downloadIcs(text,name){
  const blob=new Blob([text],{type:"text/calendar"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),1500);
}

async function load(){
  const { data, error } = await supabase
    .from("meals")
    .select("id,meal,starts_at,ends_at,notes")
    .order("starts_at",{ascending:true});

  if(error){
    $("msg").className="notice warn";
    $("msg").textContent="Ø®Ø·Ø£: "+error.message;
    return;
  }

  if(!data.length){
    $("msg").textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.";
    return;
  }

  $("msg").className="notice ok";
  $("msg").textContent="ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„.";

  const wrap=document.createElement("div");
  wrap.className="cardsGrid";

  for(const r of data){
    const g=formatGregorian(r.starts_at);
    const h=formatHijri(r.starts_at);
    const t=`${formatTime(r.starts_at)} â€“ ${formatTime(r.ends_at)}`;

    const title=`${APP_TITLE} â€” ${mealLabel(r.meal)}`;
    const desc=`${mealLabel(r.meal)}\n${g}\n${h}\n${t}\nØ§Ù„Ù…ÙˆÙ‚Ø¹: ${DEFAULT_LOCATION}`;

    const card=document.createElement("div");
    card.className="card mealCard mealCardPro";
    card.dataset.meal=r.meal;

    const top=document.createElement("div");
    top.className="mealTopPro";

    const left=document.createElement("div");
    left.innerHTML=`
      <div class="mealBadge">ğŸ½ï¸ ${mealLabel(r.meal)}</div>
      <div style="height:8px"></div>
      <div class="mealMeta">
        <div><b>ğŸ“… ${g}</b></div>
        <div>ğŸ•Œ ${h}</div>
        <div>â° ${t}</div>
      </div>
    `;

    const actions=document.createElement("div");
    actions.style.display="flex";
    actions.style.flexDirection="column";
    actions.style.gap="8px";

    const btnIcs=document.createElement("button");
    btnIcs.className="btn secondary primaryAction";
    btnIcs.textContent="ğŸ“… Ø£Ø¶Ù Ù„Ù„ØªÙ‚ÙˆÙŠÙ…";
    btnIcs.onclick=()=>{
      const ics=makeIcs({
        title,
        description:desc,
        location:DEFAULT_LOCATION,
        start:new Date(r.starts_at),
        end:new Date(r.ends_at)
      });
      downloadIcs(ics,"dawriya.ics");
    };

    const btnWa=document.createElement("button");
    btnWa.className="btn";
    btnWa.style.background="#25D366";
    btnWa.textContent="ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨";
    btnWa.onclick=()=>{
      const text=`ğŸ½ï¸ ${mealLabel(r.meal)}\nğŸ“… ${g}\nğŸ•Œ ${h}\nâ° ${t}\nğŸ“ ${DEFAULT_LOCATION}\n\n${location.href}`;
      const url=`https://wa.me/?text=${encodeURIComponent(text)}`;
      window.open(url,"_blank");
    };

    actions.appendChild(btnIcs);
    actions.appendChild(btnWa);

    top.appendChild(left);
    top.appendChild(actions);
    card.appendChild(top);

    wrap.appendChild(card);
  }

  $("list").innerHTML="";
  $("list").appendChild(wrap);
}

load();
</script>
</body>
</html>
