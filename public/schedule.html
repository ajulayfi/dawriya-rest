<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø¯ÙˆØ±ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© â€” Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±</title>

  <link rel="stylesheet" href="./assets/app.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Ø§Ø­ØªÙŠØ§Ø· Ù„Ùˆ CSS Ø¹Ù†Ø¯Ùƒ Ù‚Ø¯ÙŠÙ… */
    .cardsGrid{display:grid;gap:12px}
    .actionsCol{display:flex;flex-direction:column;gap:8px;min-width:180px}
    @media (max-width:720px){.actionsCol{min-width:unset}}
    .pastCard{opacity:.45;filter:grayscale(.2)}
    details.pastDetails{
      border:1px solid var(--line,#e5e7eb);
      border-radius:16px;
      background:#fff;
      padding:10px 12px;
      margin-top:14px;
    }
    details.pastDetails summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
      font-weight:800;
    }
    details.pastDetails summary::-webkit-details-marker{display:none}
    .summaryHint{color:var(--muted,#64748b);font-weight:600;font-size:12px}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line,#e5e7eb);
      background:#fff;font-size:12px;color:var(--muted,#64748b)
    }
  </style>
</head>

<body>
<div class="container">

  <div class="header">
    <div class="title">
      <h1 id="pageTitle">Ø¯ÙˆØ±ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</h1>
      <div class="sub">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±ÙŠ â€” Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙ‚ÙˆÙŠÙ… Ø£Ùˆ Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</div>
    </div>
    <div class="toolbar">
      <a class="btn secondary" href="./login.html">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
    </div>
  </div>

  <!-- Ø£Ù‚Ø±Ø¨ Ù…Ù†Ø§Ø³Ø¨Ø© + Ø¹Ø¯Ø§Ø¯ -->
  <div id="nextBox" class="nextBanner" style="display:none"></div>

  <!-- Ø£Ø¯ÙˆØ§Øª -->
  <div class="stickyBar">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <span class="badge" id="monthBadge">â€”</span>
      <span class="badge">ğŸ“ <b style="color:#111827" id="loc">Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</b></span>
    </div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <input id="monthPick" class="input" type="month" style="width:160px"/>
      <button id="reload" class="btn secondary">ØªØ­Ø¯ÙŠØ«</button>
    </div>

    <div class="chips" id="chips">
      <button class="chip active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
      <button class="chip" data-filter="futoor">ÙØ·ÙˆØ±</button>
      <button class="chip" data-filter="ghada">ØºØ¯Ø§</button>
      <button class="chip" data-filter="asha">Ø¹Ø´Ø§</button>
      <button class="chip" data-filter="suhoor">Ø³Ø­ÙˆØ±</button>
      <button class="chip" data-filter="upcoming">Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</button>
    </div>
  </div>

  <div id="msg" class="notice">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„â€¦</div>

  <div class="card" style="margin-top:12px">
    <div style="font-weight:800">Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div>
    <div class="small">Ø§Ù„ÙŠÙˆÙ… Ù…Ù…ÙŠØ² â€” Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø¯Ø§Ø®Ù„ Ù‚Ø³Ù… Ù…Ø·ÙˆÙŠ Ø¨Ø§Ù„Ø£Ø³ÙÙ„.</div>
    <div class="hr"></div>

    <div id="list">â€”</div>

    <!-- Past accordion will be injected here -->
    <div id="pastWrap"></div>
  </div>

</div>

<script type="module">
  import { SUPABASE_URL, SUPABASE_ANON_KEY, APP_TITLE, DEFAULT_LOCATION, TZ } from "./assets/config.js";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2,"0");

  $("pageTitle").textContent = APP_TITLE;
  $("loc").textContent = DEFAULT_LOCATION;

  let activeFilter = "all";
  let cachedRows = [];
  let nextMeal = null;
  let countdownTimer = null;

  function getMonthParam(){
    const u = new URL(location.href);
    const m = u.searchParams.get("month");
    if (m && /^\d{4}-\d{2}$/.test(m)) return m;
    const d = new Date();
    return d.getFullYear() + "-" + pad2(d.getMonth()+1);
  }

  function monthLabel(month){
    const parts = month.split("-");
    const y = Number(parts[0]), m = Number(parts[1]);
    const d = new Date(Date.UTC(y, m-1, 1));
    return new Intl.DateTimeFormat("ar-SA", { year:"numeric", month:"long", timeZone: TZ }).format(d);
  }

  function mealLabel(key){
    const map = { futoor:"ÙØ·ÙˆØ±", ghada:"ØºØ¯Ø§", asha:"Ø¹Ø´Ø§", suhoor:"Ø³Ø­ÙˆØ±" };
    return map[key] || key;
  }

  function formatGregorianDayAndDate(iso){
    const d = new Date(iso);
    const weekday = new Intl.DateTimeFormat("ar-SA", { weekday:"long", timeZone: TZ }).format(d);
    const ymd = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" }).format(d);
    const arr = ymd.split("-");
    return weekday + " " + arr[2] + "/" + arr[1] + "/" + arr[0];
  }

  function formatHijriWithPrefix(iso){
    const d = new Date(iso);
    try{
      const h = new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura", { year:"numeric", month:"long", day:"numeric", timeZone: TZ }).format(d);
      return "Ø§Ù„Ù…ÙˆØ§ÙÙ‚ " + h;
    }catch(e){
      return "Ø§Ù„Ù…ÙˆØ§ÙÙ‚ â€”";
    }
  }

  function formatTime12(iso){
    const d = new Date(iso);
    return new Intl.DateTimeFormat("ar-SA", { hour:"numeric", minute:"2-digit", hour12:true, timeZone: TZ }).format(d);
  }

  function isTodayTZ(iso){
    const a = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" }).format(new Date(iso));
    const b = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" }).format(new Date());
    return a === b;
  }

  function formatCountdown(ms){
    if (ms <= 0) return "Ø¨Ø¯Ø£Øª Ø§Ù„Ø¢Ù†";
    const s = Math.floor(ms/1000);
    const days = Math.floor(s/86400);
    const hrs  = Math.floor((s%86400)/3600);
    const mins = Math.floor((s%3600)/60);
    if (days > 0) return "Ø¨Ø§Ù‚ÙŠ " + days + " ÙŠÙˆÙ… Ùˆ " + hrs + " Ø³Ø§Ø¹Ø©";
    if (hrs > 0)  return "Ø¨Ø§Ù‚ÙŠ " + hrs + " Ø³Ø§Ø¹Ø© Ùˆ " + mins + " Ø¯Ù‚ÙŠÙ‚Ø©";
    return "Ø¨Ø§Ù‚ÙŠ " + mins + " Ø¯Ù‚ÙŠÙ‚Ø©";
  }

  function setMessage(kind, text){
    $("msg").className = kind ? ("notice " + kind) : "notice";
    $("msg").textContent = text;
  }

  function setFilter(f){
    activeFilter = f;
    document.querySelectorAll(".chip").forEach(btn => btn.classList.toggle("active", btn.dataset.filter === f));
    renderAll();
  }

  $("chips").addEventListener("click", (e) => {
    const btn = e.target.closest(".chip");
    if (!btn) return;
    setFilter(btn.dataset.filter);
  });

  $("reload").addEventListener("click", () => loadMonth($("monthPick").value));
  $("monthPick").addEventListener("change", () => loadMonth($("monthPick").value));

  function pickNextUpcoming(rows){
    const now = new Date();
    const upcoming = rows
      .filter(r => new Date(r.starts_at) >= now)
      .sort((a,b)=> new Date(a.starts_at) - new Date(b.starts_at));
    return upcoming.length ? upcoming[0] : null;
  }

  function showNextBanner(r){
    const box = $("nextBox");
    if (!r){
      box.style.display = "none";
      return;
    }
    const g = formatGregorianDayAndDate(r.starts_at);
    const h = formatHijriWithPrefix(r.starts_at);
    const t = formatTime12(r.starts_at) + " â€“ " + formatTime12(r.ends_at);

    box.style.display = "block";
    box.innerHTML = "";

    const line1 = document.createElement("div");
    line1.innerHTML = "â­ï¸ <b>Ø£Ù‚Ø±Ø¨ Ù…Ù†Ø§Ø³Ø¨Ø©:</b> " + mealLabel(r.meal);

    const line2 = document.createElement("div");
    line2.className = "small";
    line2.textContent = "ğŸ“… " + g;

    const line3 = document.createElement("div");
    line3.className = "small";
    line3.textContent = "ğŸ•Œ " + h;

    const line4 = document.createElement("div");
    line4.className = "small";
    line4.textContent = "â° " + t;

    const line5 = document.createElement("div");
    line5.style.marginTop = "6px";
    const cd = document.createElement("b");
    cd.id = "countDown";
    cd.textContent = "â³ ...";
    line5.appendChild(cd);

    box.appendChild(line1);
    box.appendChild(line2);
    box.appendChild(line3);
    box.appendChild(line4);
    box.appendChild(line5);
  }

  function runCountdown(){
    if (countdownTimer) clearInterval(countdownTimer);
    countdownTimer = null;
    if (!nextMeal) return;

    const tick = () => {
      const el = document.getElementById("countDown");
      if (!el) return;
      const ms = new Date(nextMeal.starts_at) - new Date();
      el.textContent = "â³ " + formatCountdown(ms);
    };

    tick();
    countdownTimer = setInterval(tick, 30000);
  }

  function makeIcs(title, description, location, start, end){
    const dt = (d) => {
      const y=d.getUTCFullYear(), mo=pad2(d.getUTCMonth()+1), da=pad2(d.getUTCDate());
      const hh=pad2(d.getUTCHours()), mm=pad2(d.getUTCMinutes()), ss=pad2(d.getUTCSeconds());
      return "" + y + mo + da + "T" + hh + mm + ss + "Z";
    };
    const esc = (s) => String(s||"").replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;");
    const uid = (crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"")) + "@dawriya-rest";

    return [
      "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Dawriya Rest//AR//EN","CALSCALE:GREGORIAN","METHOD:PUBLISH",
      "BEGIN:VEVENT",
      "UID:" + uid,
      "DTSTAMP:" + dt(new Date()),
      "DTSTART:" + dt(start),
      "DTEND:" + dt(end),
      "SUMMARY:" + esc(title),
      "DESCRIPTION:" + esc(description),
      "LOCATION:" + esc(location),
      "END:VEVENT",
      "END:VCALENDAR"
    ].join("\r\n");
  }

  function downloadIcs(text, filename){
    const blob = new Blob([text], { type:"text/calendar;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 1500);
  }

  function openWhatsAppShare(text){
    window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
  }

  function buildCard(r, { variant }){
    // variant: "normal" | "past"
    const now = new Date();
    const isPast = new Date(r.starts_at) < now;
    const isToday = isTodayTZ(r.starts_at);
    const isNext = nextMeal && r.id === nextMeal.id;

    const hosts = (r._hostNames && r._hostNames.length) ? r._hostNames.join(" â€“ ") : "â€”";
    const g = formatGregorianDayAndDate(r.starts_at);
    const h = formatHijriWithPrefix(r.starts_at);
    const t = formatTime12(r.starts_at) + " â€“ " + formatTime12(r.ends_at);

    const card = document.createElement("div");
    card.className = "card mealCardPro mealCard";
    card.dataset.meal = r.meal;

    if (variant === "past" || isPast){
      card.classList.add("pastCard");
    }

    // Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„ÙŠÙˆÙ… / Ø§Ù„Ø£Ù‚Ø±Ø¨ ÙÙŠ Ù‚Ø³Ù… ØºÙŠØ± Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ
    if (variant !== "past"){
      if (isToday){
        card.style.border = "1px solid rgba(245,158,11,.55)";
        card.style.background = "rgba(245,158,11,.06)";
      } else if (isNext){
        card.style.border = "1px solid rgba(34,197,94,.55)";
        card.style.background = "rgba(34,197,94,.06)";
      }
    }

    const top = document.createElement("div");
    top.className = "mealTopPro";

    const left = document.createElement("div");

    const badge = document.createElement("div");
    badge.className = "mealBadge";
    badge.textContent = "ğŸ½ï¸ " + mealLabel(r.meal);

    const meta = document.createElement("div");
    meta.className = "mealMeta";
    meta.style.marginTop = "8px";

    const lineA = document.createElement("div");
    lineA.innerHTML = "<b style='color:#0f172a'>ğŸ“… " + g + "</b>";
    const lineB = document.createElement("div");
    lineB.textContent = "ğŸ•Œ " + h;
    const lineC = document.createElement("div");
    lineC.textContent = "â° " + t;

    meta.appendChild(lineA);
    meta.appendChild(lineB);
    meta.appendChild(lineC);

    left.appendChild(badge);
    left.appendChild(meta);

    // ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø£Ù‚Ø±Ø¨ (ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)
    if (variant !== "past"){
      const tagText = isToday ? "ğŸ“ Ø§Ù„ÙŠÙˆÙ…" : (isNext ? "â­ï¸ Ø§Ù„Ø£Ù‚Ø±Ø¨" : "");
      if (tagText){
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.style.marginTop = "10px";
        pill.textContent = tagText;
        left.appendChild(pill);
      }
    }

    const actions = document.createElement("div");
    actions.className = "actionsCol";

    const btnIcs = document.createElement("button");
    btnIcs.className = "btn secondary primaryAction";
    btnIcs.textContent = "ğŸ“… Ø£Ø¶Ù Ù„Ù„ØªÙ‚ÙˆÙŠÙ…";
    btnIcs.addEventListener("click", ()=>{
      const title = APP_TITLE + " â€” " + mealLabel(r.meal);
      const descParts = [
        "ğŸ½ï¸ " + mealLabel(r.meal),
        "ğŸ“… " + g,
        "ğŸ•Œ " + h,
        "â° " + t,
        "ğŸ“ " + DEFAULT_LOCATION,
        "ğŸ‘¥ Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†: " + hosts
      ];
      if (r.notes) descParts.push("ğŸ“ " + r.notes);
      const desc = descParts.join("\\n");

      const ics = makeIcs(title, desc, DEFAULT_LOCATION, new Date(r.starts_at), new Date(r.ends_at));
      const ymd = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" }).format(new Date(r.starts_at));
      downloadIcs(ics, APP_TITLE + "-" + mealLabel(r.meal) + "-" + ymd + ".ics");
    });

    const btnWa = document.createElement("button");
    btnWa.className = "btn";
    btnWa.style.background = "#25D366";
    btnWa.textContent = "ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨";
    btnWa.addEventListener("click", ()=>{
      const msg = [
        "ğŸ½ï¸ " + mealLabel(r.meal),
        "ğŸ“… " + g,
        "ğŸ•Œ " + h,
        "â° " + t,
        "ğŸ“ " + DEFAULT_LOCATION,
        "ğŸ‘¥ Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†: " + hosts
      ];
      if (r.notes) msg.push("ğŸ“ " + r.notes);
      msg.push("");
      msg.push(location.href);
      openWhatsAppShare(msg.join("\n"));
    });

    actions.appendChild(btnIcs);
    actions.appendChild(btnWa);

    top.appendChild(left);
    top.appendChild(actions);

    const hostsBlock = document.createElement("div");
    hostsBlock.className = "hostsBlock";

    const ht = document.createElement("div");
    ht.className = "hostsTitle";
    ht.textContent = "Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†";

    const hn = document.createElement("div");
    hn.className = "hostsNames";
    hn.textContent = hosts;

    hostsBlock.appendChild(ht);
    hostsBlock.appendChild(hn);

    if (r.notes){
      const note = document.createElement("div");
      note.className = "small";
      note.style.marginTop = "8px";
      note.textContent = "Ù…Ù„Ø§Ø­Ø¸Ø©: " + r.notes;
      hostsBlock.appendChild(note);
    }

    card.appendChild(top);
    card.appendChild(hostsBlock);
    return card;
  }

  function renderAll(){
    const now = new Date();

    // ÙÙ„ØªØ± Ø£Ø³Ø§Ø³ÙŠ (Ù„Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·)
    let base = cachedRows.slice();

    if (activeFilter === "upcoming") base = base.filter(r => new Date(r.starts_at) >= now);
    else if (activeFilter !== "all") base = base.filter(r => r.meal === activeFilter);

    // Ù†ÙØµÙ„ Ø§Ù„Ù…Ø§Ø¶ÙŠ Ø¹Ù† ØºÙŠØ±Ù‡
    const currentRows = base.filter(r => new Date(r.starts_at) >= now);
    const pastRowsAll = cachedRows.filter(r => new Date(r.starts_at) < now);

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: Ø§Ù„ÙŠÙˆÙ… Ø£ÙˆÙ„Ù‹Ø§ Ø«Ù… Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø«Ù… Ø§Ù„Ø¨Ù‚ÙŠØ©
    currentRows.sort((a,b)=>{
      const aToday = isTodayTZ(a.starts_at) ? 0 : 1;
      const bToday = isTodayTZ(b.starts_at) ? 0 : 1;
      if (aToday !== bToday) return aToday - bToday;
      return new Date(a.starts_at) - new Date(b.starts_at);
    });

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø§Ø¶ÙŠ: Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
    pastRowsAll.sort((a,b)=> new Date(b.starts_at) - new Date(a.starts_at));

    // Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    const wrap = document.createElement("div");
    wrap.className = "cardsGrid";

    if (!currentRows.length){
      wrap.innerHTML = '<div class="notice">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ù‚Ø§Ø¯Ù…Ø© Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ÙÙ„ØªØ±.</div>';
    } else {
      currentRows.forEach(r => wrap.appendChild(buildCard(r, { variant: "normal" })));
    }

    $("list").innerHTML = "";
    $("list").appendChild(wrap);

    // Ù‚Ø³Ù… Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© (Ù…Ø·ÙˆÙŠ)
    const pastWrap = $("pastWrap");
    pastWrap.innerHTML = "";

    if (pastRowsAll.length){
      const details = document.createElement("details");
      details.className = "pastDetails";
      details.open = false; // Ù…Ø·ÙˆÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§

      const summary = document.createElement("summary");

      const left = document.createElement("div");
      left.textContent = "Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© (" + pastRowsAll.length + ")";

      const right = document.createElement("div");
      right.className = "summaryHint";
      right.textContent = "Ø§Ø¶ØºØ· Ù„Ù„Ø¹Ø±Ø¶";

      summary.appendChild(left);
      summary.appendChild(right);

      const inner = document.createElement("div");
      inner.style.marginTop = "12px";

      const grid = document.createElement("div");
      grid.className = "cardsGrid";

      pastRowsAll.forEach(r => grid.appendChild(buildCard(r, { variant: "past" })));

      inner.appendChild(grid);
      details.appendChild(summary);
      details.appendChild(inner);

      pastWrap.appendChild(details);
    }
  }

  async function loadMonth(m){
    $("monthPick").value = m;
    $("monthBadge").textContent = monthLabel(m);

    setMessage("", "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„â€¦");
    $("list").textContent = "â€”";
    $("pastWrap").innerHTML = "";

    const start = m + "-01T00:00:00+03:00";
    const parts = m.split("-");
    const yy = Number(parts[0]), mm = Number(parts[1]);
    const endDate = new Date(Date.UTC(yy, mm, 1, 0,0,0));
    const end = endDate.getUTCFullYear() + "-" + pad2(endDate.getUTCMonth()+1) + "-" + pad2(endDate.getUTCDate()) + "T00:00:00+03:00";

    // âœ… JOIN: Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ† Ù…Ø¨Ø§Ø´Ø±Ø©
    const resMeals = await supabase
      .from("meals")
      .select(`
        id, meal, starts_at, ends_at, notes,
        meal_hosts (
          member_id,
          members ( full_name )
        )
      `)
      .gte("starts_at", start)
      .lt("starts_at", end)
      .order("starts_at", { ascending:true });

    if (resMeals.error){
      setMessage("warn", "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + resMeals.error.message);
      $("nextBox").style.display = "none";
      cachedRows = [];
      nextMeal = null;
      if (countdownTimer) clearInterval(countdownTimer);
      return;
    }

    const rows = resMeals.data || [];
    if (!rows.length){
      setMessage("", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.");
      $("list").innerHTML = '<div class="notice">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø§Øª.</div>';
      $("nextBox").style.display = "none";
      cachedRows = [];
      nextMeal = null;
      if (countdownTimer) clearInterval(countdownTimer);
      return;
    }

    // âœ… Ø¨Ù†Ø§Ø¡ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†
    rows.forEach(r => {
      const hosts = (r.meal_hosts || [])
        .map(h => h.members?.full_name)
        .filter(Boolean);
      r._hostNames = hosts;
    });

    cachedRows = rows;
    setMessage("ok", "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„.");

    nextMeal = pickNextUpcoming(rows);
    showNextBanner(nextMeal);
    runCountdown();

    renderAll();
  }

  // init
  const initialMonth = getMonthParam();
  $("monthPick").value = initialMonth;
  $("monthBadge").textContent = monthLabel(initialMonth);
  loadMonth(initialMonth);
</script>

</body>
</html>
