<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ุฌุฏูู ุงูุดูุฑ</title>
  <link rel="stylesheet" href="./assets/app.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">
      <h1 id="hTitle">ุฌุฏูู ุงูุดูุฑ</h1>
      <div class="sub" id="hSub">โ</div>
    </div>
    <div class="toolbar">
      <a class="btn secondary" href="./login.html">ุฏุฎูู ุงูุฅุฏุงุฑุฉ</a>
      <span class="badge" id="lastUpdate">โ</span>
    </div>
  </div>

  <div id="gate" class="notice warn" style="display:none"></div>

  <div class="card" id="monthNav">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <button id="prev" class="btn secondary">โ ุงูุดูุฑ ุงูุณุงุจู</button>
      <div class="badge">ุงูุดูุฑ: <span class="kbd" id="monthKey">โ</span></div>
      <button id="next" class="btn secondary">ุงูุดูุฑ ุงูุชุงูู โ</button>
    </div>
  </div>

  <div id="empty" class="card" style="margin-top:12px;display:none">
    <div style="font-weight:700">ูุง ููุฌุฏ ุฌุฏูู ููุฐุง ุงูุดูุฑ ุญุชู ุงูุขู.</div>
    <div class="small" style="margin-top:6px">ูุชู ุชุญุฏูุซ ุงูุฌุฏููุฉ ูู ุงูุฅุฏุงุฑุฉ ุจุฏุงูุฉ ูู ุดูุฑ.</div>
  </div>

  <div id="list" style="margin-top:12px;display:grid;gap:12px"></div>
</div>

<script type="module">
  import {
    supabase, setTitle, mealLabel, getMonthParam, getAccessParam, monthLabel,
    formatGregorian, formatHijriUmmAlQura, formatTime12, downloadICS, el, validateAccessToken
  } from "./assets/app.js";
  import { APP_TITLE } from "./assets/config.js";

  const gate = document.getElementById("gate");
  const list = document.getElementById("list");
  const empty = document.getElementById("empty");
  const hTitle = document.getElementById("hTitle");
  const hSub = document.getElementById("hSub");
  const monthKey = document.getElementById("monthKey");
  const lastUpdate = document.getElementById("lastUpdate");

  const prevBtn = document.getElementById("prev");
  const nextBtn = document.getElementById("next");

  function yyyymmToParts(m){ const [y,mo]=m.split("-").map(Number); return {y,mo}; }
  function shiftMonth(m, delta){
    const {y,mo}=yyyymmToParts(m);
    const d = new Date(Date.UTC(y, mo-1+delta, 1, 12, 0, 0));
    return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,"0")}`;
  }

  function setHeader(month){
    const ml = monthLabel(month);
    hTitle.textContent = `${APP_TITLE} โ ${ml}`;
    hSub.textContent = "ูููุงุฏู (ุฃุณุงุณ) + ูุฌุฑู ุฃู ุงููุฑู (ููุนุฑุถ)";
    setTitle(ml);
    monthKey.textContent = month;
  }

  function setLastUpdate(ts){
    if (!ts){ lastUpdate.textContent = "โ"; return; }
    const d = new Date(ts);
    const s = new Intl.DateTimeFormat("ar-SA", { timeZone:"Asia/Riyadh", day:"2-digit", month:"short", year:"numeric" }).format(d);
    lastUpdate.textContent = `ุขุฎุฑ ุชุญุฏูุซ: ${s}`;
  }

  function navTo(month){
    const url = new URL(window.location.href);
    url.searchParams.set("month", month);
    history.replaceState({}, "", url.toString());
    loadMonth(month);
  }

  async function loadMonth(month){
    const access = getAccessParam();
    if (!validateAccessToken(access)){
      gate.style.display = "block";
      gate.textContent = "ุงูุฑุงุจุท ุบูุฑ ุตุญูุญ ุฃู ูุงูุต. ุงูุชุญ ุงูุฑุงุจุท ูู ูุฌููุนุฉ ูุงุชุณุงุจ.";
      list.innerHTML = "";
      empty.style.display = "none";
      return;
    }
    gate.style.display = "none";
    setHeader(month);

    const { data, error } = await supabase.rpc("get_month_schedule", { p_month: month });
    if (error){
      empty.style.display = "block";
      empty.querySelector("div").textContent = "ุญุฏุซ ุฎุทุฃ ุจุงููุฑุงุกุฉ. ุฑุงุฌุน ุฅุนุฏุงุฏุงุช Supabase.";
      list.innerHTML = "";
      return;
    }

    const rows = data || [];
    if (!rows.length){
      empty.style.display = "block";
      list.innerHTML = "";
      setLastUpdate(null);
      return;
    }

    empty.style.display = "none";
    list.innerHTML = "";
    setLastUpdate(rows.reduce((mx, r) => (!mx || r.created_at > mx) ? r.created_at : mx, null));

    rows.forEach(r => {
      const hostsText = r.hosts || "โ";
      const card = el("div", { class:"card mealCard", "data-meal": r.meal }, [
        el("div", { class:"mealTop" }, [
          el("div", {}, [
            el("div", { class:"mealName" }, [`${mealLabel(r.meal)} โ ${r.location || "ุงูุงุณุชุฑุงุญุฉ"}`]),
            el("div", { class:"mealMeta" }, [
              el("div", {}, [formatGregorian(r.starts_at)]),
              el("div", {}, [formatHijriUmmAlQura(r.starts_at)]),
              el("div", {}, [`${formatTime12(r.starts_at)} โ ${formatTime12(r.ends_at)}`]),
            ])
          ]),
          el("button", { class:"btn secondary", onclick: () => {
            downloadICS({
              meal: r.meal,
              startsAtISO: r.starts_at,
              endsAtISO: r.ends_at,
              hostsText,
              notes: r.notes || ""
            });
          }}, ["๐ ุฃุถู ููุชูููู"])
        ]),
        el("div", { class:"mealHosts" }, [
          el("span", { class:"small" }, ["ุงูุฏุงุนูู: "]),
          el("span", {}, [hostsText])
        ]),
        r.notes ? el("div", { class:"small", style:"margin-top:8px" }, [`ููุงุญุธุฉ: ${r.notes}`]) : null
      ]);
      list.appendChild(card);
    });
  }

  const initialMonth = getMonthParam();
  setHeader(initialMonth);

  prevBtn.addEventListener("click", () => navTo(shiftMonth(getMonthParam(), -1)));
  nextBtn.addEventListener("click", () => navTo(shiftMonth(getMonthParam(), +1)));

  loadMonth(initialMonth);
</script>
</body>
</html>
