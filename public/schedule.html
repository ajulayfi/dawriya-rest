<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø¯ÙˆØ±ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© â€” Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±</title>
  <link rel="stylesheet" href="./assets/app.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">
      <h1 id="pageTitle">Ø¯ÙˆØ±ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</h1>
      <div class="sub">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±ÙŠ + Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙ‚ÙˆÙŠÙ…</div>
    </div>
    <div class="toolbar">
      <span class="badge" id="monthBadge">â€”</span>
      <a class="btn secondary" href="./login.html">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
    </div>
  </div>

  <div id="msg" class="notice">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„â€¦</div>

  <div class="card" style="margin-top:12px">
    <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-weight:700">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±</div>
        <div class="small">Ø§Ø¶ØºØ· â€œØ£Ø¶Ù Ù„Ù„ØªÙ‚ÙˆÙŠÙ…â€ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©.</div>
      </div>
      <div class="toolbar">
        <input id="monthPick" class="input" type="month"/>
        <button id="reload" class="btn secondary">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="list">â€”</div>
  </div>
</div>

<script type="module">
  import { SUPABASE_URL, SUPABASE_ANON_KEY, APP_TITLE, DEFAULT_LOCATION, TZ } from "./assets/config.js";

  const $ = (id) => document.getElementById(id);
  const pad2 = (n)=>String(n).padStart(2,"0");

  function getMonthParam(){
    const u = new URL(location.href);
    const m = u.searchParams.get("month");
    if (m && /^\d{4}-\d{2}$/.test(m)) return m;
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  }

  function monthLabel(month){
    const [y,m]=month.split("-").map(Number);
    const d = new Date(Date.UTC(y,m-1,1));
    return new Intl.DateTimeFormat("ar-SA", { year:"numeric", month:"long", timeZone: TZ }).format(d);
  }

  function formatGregorian(iso){
    const d = new Date(iso);
    return new Intl.DateTimeFormat("ar-SA", { weekday:"long", year:"numeric", month:"long", day:"numeric", timeZone: TZ }).format(d);
  }

  function formatHijriUmmAlQura(iso){
    const d = new Date(iso);
    try{
      return new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura", { year:"numeric", month:"long", day:"numeric", timeZone: TZ }).format(d);
    }catch{
      return "â€”";
    }
  }

  function formatTime12(iso){
    const d = new Date(iso);
    return new Intl.DateTimeFormat("ar-SA", { hour:"numeric", minute:"2-digit", hour12:true, timeZone: TZ }).format(d);
  }

  function mealLabel(key){
    return ({ futoor:"ÙØ·ÙˆØ±", ghada:"ØºØ¯Ø§", asha:"Ø¹Ø´Ø§", suhoor:"Ø³Ø­ÙˆØ±" }[key] || key);
  }

  function makeIcs({ title, description, location, start, end }){
    const dt = (d) => {
      const y=d.getUTCFullYear(), mo=pad2(d.getUTCMonth()+1), da=pad2(d.getUTCDate());
      const hh=pad2(d.getUTCHours()), mm=pad2(d.getUTCMinutes()), ss=pad2(d.getUTCSeconds());
      return `${y}${mo}${da}T${hh}${mm}${ss}Z`;
    };
    const esc = (s) => String(s||"")
      .replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;");
    const uid = `${crypto.randomUUID()}@dawriya-rest`;
    const now = dt(new Date());

    return [
      "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Dawriya Rest//AR//EN","CALSCALE:GREGORIAN","METHOD:PUBLISH",
      "BEGIN:VEVENT",
      `UID:${uid}`,
      `DTSTAMP:${now}`,
      `DTSTART:${dt(start)}`,
      `DTEND:${dt(end)}`,
      `SUMMARY:${esc(title)}`,
      `DESCRIPTION:${esc(description)}`,
      `LOCATION:${esc(location)}`,
      "END:VEVENT","END:VCALENDAR"
    ].join("\r\n");
  }

  function downloadIcs(icsText, filename){
    const blob = new Blob([icsText], { type:"text/calendar;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  }

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  $("pageTitle").textContent = APP_TITLE;
  const month = getMonthParam();
  $("monthPick").value = month;
  $("monthBadge").textContent = monthLabel(month);

  $("reload").addEventListener("click", ()=>loadMonth($("monthPick").value));
  $("monthPick").addEventListener("change", ()=>loadMonth($("monthPick").value));

  async function loadMonth(m){
    $("monthBadge").textContent = monthLabel(m);
    $("msg").className = "notice";
    $("msg").textContent = "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„â€¦";
    $("list").textContent = "â€”";

    const start = `${m}-01T00:00:00+03:00`;
    const [yy, mm] = m.split("-").map(Number);
    const endDate = new Date(Date.UTC(yy, mm, 1, 0, 0, 0));
    const end = `${endDate.getUTCFullYear()}-${pad2(endDate.getUTCMonth()+1)}-${pad2(endDate.getUTCDate())}T00:00:00+03:00`;

    // 1) meals
    const { data: meals, error: e1 } = await supabase
      .from("meals")
      .select("id, meal, starts_at, ends_at, notes")
      .gte("starts_at", start)
      .lt("starts_at", end)
      .order("starts_at", { ascending:true });

    if (e1){
      $("msg").className="notice warn";
      $("msg").textContent = `ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ meals: ${e1.message}`;
      $("list").textContent="â€”";
      return;
    }

    const rows = meals || [];
    if (!rows.length){
      $("msg").className="notice";
      $("msg").textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
      $("list").innerHTML = `<div class="notice">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø§Øª.</div>`;
      return;
    }

    // 2) meal_hosts for those meals
    const mealIds = rows.map(r=>r.id);
    const { data: links, error: e2 } = await supabase
      .from("meal_hosts")
      .select("meal_id, member_id")
      .in("meal_id", mealIds);

    if (e2){
      $("msg").className="notice warn";
      $("msg").textContent = `ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†: ${e2.message}`;
      $("list").textContent="â€”";
      return;
    }

    const memberIds = [...new Set((links||[]).map(x=>x.member_id))];
    let membersMap = new Map();

    if (memberIds.length){
      const { data: mems, error: e3 } = await supabase
        .from("members")
        .select("id, full_name")
        .in("id", memberIds);

      if (!e3){
        (mems||[]).forEach(m=>membersMap.set(m.id, m.full_name));
      }
    }

    const hostsByMeal = new Map();
    (links||[]).forEach(l=>{
      if (!hostsByMeal.has(l.meal_id)) hostsByMeal.set(l.meal_id, []);
      hostsByMeal.get(l.meal_id).push(membersMap.get(l.member_id) || "â€”");
    });

    $("msg").className="notice ok";
    $("msg").textContent = "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„.";

    const wrap = document.createElement("div");
    wrap.style.display="grid";
    wrap.style.gap="12px";

    for (const r of rows){
      const hostNames = (hostsByMeal.get(r.id) || []).filter(Boolean);
      const hostsText = hostNames.length ? hostNames.join(" â€“ ") : "â€”";

      const title = `${APP_TITLE} â€” ${mealLabel(r.meal)}`;
      const desc =
`${mealLabel(r.meal)}
Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†: ${hostsText}
${r.notes ? ("Ù…Ù„Ø§Ø­Ø¸Ø©: " + r.notes) : ""}`.trim();

      const startD = new Date(r.starts_at);
      const endD = new Date(r.ends_at);

      const card = document.createElement("div");
      card.className = "card mealCard";
      card.dataset.meal = r.meal;

      const top = document.createElement("div");
      top.className = "mealTop";

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="mealName">${mealLabel(r.meal)}</div>
        <div class="mealMeta">
          <div>${formatGregorian(r.starts_at)}</div>
          <div>${formatHijriUmmAlQura(r.starts_at)}</div>
          <div>${formatTime12(r.starts_at)} â€“ ${formatTime12(r.ends_at)}</div>
        </div>
      `;

      const btn = document.createElement("button");
      btn.className = "btn secondary";
      btn.textContent = "ğŸ“… Ø£Ø¶Ù Ù„Ù„ØªÙ‚ÙˆÙŠÙ…";
      btn.addEventListener("click", () => {
        const ics = makeIcs({
          title,
          description: desc,
          location: DEFAULT_LOCATION,
          start: startD,
          end: endD
        });
        const ymd = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" }).format(new Date(r.starts_at));
        downloadIcs(ics, `${APP_TITLE}-${mealLabel(r.meal)}-${ymd}.ics`);
      });

      top.appendChild(left);
      top.appendChild(btn);

      const hosts = document.createElement("div");
      hosts.className = "mealHosts";
      hosts.innerHTML = `<span class="small">Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†: </span><span>${hostsText}</span>`;

      card.appendChild(top);
      card.appendChild(hosts);

      if (r.notes){
        const note = document.createElement("div");
        note.className = "small";
        note.style.marginTop="8px";
        note.textContent = `Ù…Ù„Ø§Ø­Ø¸Ø©: ${r.notes}`;
        card.appendChild(note);
      }

      wrap.appendChild(card);
    }

    $("list").innerHTML="";
    $("list").appendChild(wrap);
  }

  loadMonth(month);
</script>
</body>
</html>
