<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
  <link rel="stylesheet" href="./assets/app.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      <div class="sub">Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ + Ø¬Ø¯ÙˆÙ„Ø© + Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨</div>
    </div>
    <div class="toolbar">
      <span id="who" class="badge">â€”</span>
      <button id="logout" class="btn secondary">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <!-- Tabs (Ø£ÙØ¶Ù„ Ù„Ù„Ø¬ÙˆØ§Ù„) -->
  <div class="tabsBar" id="tabsBar">
    <button class="tabBtn active" data-tab="membersSec">ğŸ‘¥ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</button>
    <button class="tabBtn" data-tab="mealSec">â• Ù…Ù†Ø§Ø³Ø¨Ø©</button>
    <button class="tabBtn" data-tab="monthSec">ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±</button>
  </div>

  <div id="status" class="notice">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚â€¦</div>

  <!-- 1) Members -->
  <section id="membersSec" class="adminSection">
    <div class="card">
      <div style="font-weight:700">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</div>
      <div class="small">Ø£Ø¶Ù/Ø¹Ø·Ù‘Ù„ Ø£Ø¹Ø¶Ø§Ø¡</div>

      <label>Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ</label>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <input id="newMember" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ" style="flex:1 1 220px"/>
        <button id="addMember" class="btn">Ø¥Ø¶Ø§ÙØ©</button>
      </div>

      <div class="hr"></div>
      <div id="membersList" class="small">â€”</div>
    </div>
  </section>

  <!-- 2) Meal editor -->
  <section id="mealSec" class="adminSection hidden">
    <div class="card" style="margin-top:12px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:700">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø§Ø³Ø¨Ø©</div>
          <div class="small">Ø§Ù„ØªØ§Ø±ÙŠØ® + (Ù…Ù† â†’ Ø¥Ù„Ù‰) ÙŠØ¯Ø¹Ù… Ø¹Ø¨ÙˆØ± Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„.</div>
        </div>
        <span class="badge">Ø§Ù„Ù…ÙƒØ§Ù†: <b style="color:#111827">Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</b></span>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <label>Ø§Ù„Ù†ÙˆØ¹</label>
          <select id="mealType" class="input">
            <option value="futoor">ÙØ·ÙˆØ±</option>
            <option value="ghada">ØºØ¯Ø§</option>
            <option value="asha">Ø¹Ø´Ø§</option>
            <option value="suhoor">Ø³Ø­ÙˆØ±</option>
          </select>
        </div>
        <div>
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…ÙŠÙ„Ø§Ø¯ÙŠ)</label>
          <input id="date" class="input" type="date"/>
        </div>
        <div>
          <label>Ù…Ù†</label>
          <input id="startTime" class="input" type="time" value="19:00"/>
        </div>
        <div>
          <label>Ø¥Ù„Ù‰</label>
          <input id="endTime" class="input" type="time" value="00:00"/>
        </div>
      </div>

      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <textarea id="notes" class="input" rows="2" placeholder="Ù…Ø«Ø§Ù„: ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙŠØ¬ÙŠØ¨ Ø´ÙŠØ¡..."></textarea>

      <div class="hr"></div>
      <div id="dupWarn" class="notice warn" style="display:none"></div>

      <div style="font-weight:700;margin:6px 0">Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†</div>
      <div id="hostsPicker" class="small">â€”</div>

      <div class="hr"></div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="saveMeal" class="btn">Ø­ÙØ¸</button>
          <button id="resetForm" class="btn secondary">ØªÙØ±ÙŠØº</button>
          <button id="deleteMeal" class="btn danger" style="display:none">Ø­Ø°Ù</button>
        </div>
        <button id="waPublish" class="btn secondary">ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨ (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</button>
      </div>

      <div id="editNote" class="small" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- 3) Month table -->
  <section id="monthSec" class="adminSection hidden">
    <div class="card" style="margin-top:12px">
      <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:700">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±</div>
          <div class="small">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ØµÙ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</div>
        </div>
        <div class="toolbar">
          <input id="monthPick" class="input" type="month"/>
          <button id="reloadMonth" class="btn secondary">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="monthTableWrap">â€”</div>
    </div>
  </section>

</div>

<script type="module">
  import {
    supabase, setTitle, mealLabel, getMonthParam, monthLabel,
    computeEndISO, formatGregorian, formatHijriUmmAlQura, formatTime12,
    waLink, el
  } from "./assets/app.js";
  import { ACCESS_TOKEN, APP_TITLE } from "./assets/config.js";

  setTitle("Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©");

  const statusEl = document.getElementById("status");
  const whoEl = document.getElementById("who");
  const logoutBtn = document.getElementById("logout");

  const newMemberEl = document.getElementById("newMember");
  const addMemberBtn = document.getElementById("addMember");
  const membersList = document.getElementById("membersList");

  const mealTypeEl = document.getElementById("mealType");
  const dateEl = document.getElementById("date");
  const startTimeEl = document.getElementById("startTime");
  const endTimeEl = document.getElementById("endTime");
  const notesEl = document.getElementById("notes");
  const hostsPicker = document.getElementById("hostsPicker");
  const dupWarn = document.getElementById("dupWarn");

  const saveMealBtn = document.getElementById("saveMeal");
  const resetFormBtn = document.getElementById("resetForm");
  const deleteMealBtn = document.getElementById("deleteMeal");
  const editNote = document.getElementById("editNote");

  const monthPick = document.getElementById("monthPick");
  const reloadMonthBtn = document.getElementById("reloadMonth");
  const monthTableWrap = document.getElementById("monthTableWrap");
  const waPublishBtn = document.getElementById("waPublish");

  // Tabs
  const tabsBarEl = document.getElementById("tabsBar");
  const sectionIds = ["membersSec","mealSec","monthSec"];
  const sections = sectionIds.map(id => document.getElementById(id));

  function setActiveTab(id){
    // Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ Ù†Ø®ÙÙŠ ØºÙŠØ± Ø§Ù„Ù…Ø®ØªØ§Ø±ØŒ ÙˆØ¹Ù„Ù‰ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± CSS ÙŠØ¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
    sections.forEach(sec => sec?.classList.toggle("hidden", sec.id !== id));
    [...tabsBarEl.querySelectorAll(".tabBtn")].forEach(b => b.classList.toggle("active", b.dataset.tab === id));
    document.getElementById(id)?.scrollIntoView({ behavior:"smooth", block:"start" });
  }

  tabsBarEl?.addEventListener("click", (e) => {
    const btn = e.target.closest(".tabBtn");
    if (!btn) return;
    setActiveTab(btn.dataset.tab);
  });

  let members = [];
  let editingMealId = null;
  let selectedHostIds = new Set();

  function setStatus(kind, text){
    statusEl.className = kind ? `notice ${kind}` : "notice";
    statusEl.textContent = text;
  }

  async function requireAdmin(){
    const { data: { user } } = await supabase.auth.getUser();
    if (!user){
      location.href = "./login.html";
      return null;
    }
    whoEl.textContent = user.email || user.id;

    const { data, error } = await supabase.rpc("is_admin");
    if (error || !data){
      setStatus("warn", "ØºÙŠØ± Ù…ØµØ±Ø­. ØªØ£ÙƒØ¯ Ø£Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø¶Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙŠ Supabase.");
      return null;
    }
    setStatus("ok", "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.");
    return user;
  }

  async function loadMembers(){
    const { data, error } = await supabase
      .from("members")
      .select("id, full_name, is_active")
      .order("full_name", { ascending: true });

    if (error){
      membersList.textContent = error.message;
      hostsPicker.textContent = "â€”";
      return;
    }
    members = data || [];
    renderMembers();
    renderHostsPicker();
  }

  function renderMembers(){
    if (!members.length){
      membersList.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø¹Ø¯.";
      return;
    }
    const wrap = el("div", {}, []);
    members.forEach(m => {
      const line = el("div", { style:"display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px dashed var(--line)" }, [
        el("div", {}, [
          el("div", { style:"font-weight:600" }, [m.full_name]),
          el("div", { class:"small" }, [m.is_active ? "Ù…ÙØ¹Ù‘Ù„" : "Ù…ÙˆÙ‚ÙˆÙ"])
        ]),
        el("button", { class:"btn secondary", onclick: async () => {
          const { error } = await supabase.from("members").update({ is_active: !m.is_active }).eq("id", m.id);
          if (error) alert(error.message);
          await loadMembers();
        }}, [m.is_active ? "Ø¥ÙŠÙ‚Ø§Ù" : "ØªÙØ¹ÙŠÙ„"])
      ]);
      wrap.appendChild(line);
    });
    membersList.innerHTML = "";
    membersList.appendChild(wrap);
  }

  function renderHostsPicker(){
    const active = members.filter(m => m.is_active);
    if (!active.length){
      hostsPicker.textContent = "Ø£Ø¶Ù Ø£Ø¹Ø¶Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹.";
      return;
    }
    const wrap = el("div", { style:"display:flex;flex-wrap:wrap;gap:10px" }, []);
    active.forEach(m => {
      const id = `host_${m.id}`;
      const cb = el("input", { type:"checkbox", id, onchange: async (e) => {
        if (e.target.checked) selectedHostIds.add(m.id);
        else selectedHostIds.delete(m.id);
        await updateDuplicateWarning();
      }});
      cb.checked = selectedHostIds.has(m.id);

      wrap.appendChild(
        el("label", { for:id, style:"display:flex;gap:8px;align-items:center;cursor:pointer;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:#fff" }, [
          cb, el("span", {}, [m.full_name])
        ])
      );
    });
    hostsPicker.innerHTML = "";
    hostsPicker.appendChild(wrap);
  }

  async function updateDuplicateWarning(){
    dupWarn.style.display = "none";
    dupWarn.textContent = "";

    const d = dateEl.value;
    if (!d || selectedHostIds.size === 0) return;

    const month = d.slice(0,7);
    const start = `${month}-01T00:00:00+03:00`;
    const [yy, mm] = month.split("-").map(Number);
    const endDate = new Date(Date.UTC(yy, mm, 1, 0, 0, 0));
    const end = `${endDate.getUTCFullYear()}-${String(endDate.getUTCMonth()+1).padStart(2,'0')}-${String(endDate.getUTCDate()).padStart(2,'0')}T00:00:00+03:00`;

    const { data, error } = await supabase
      .from("meal_hosts")
      .select("member_id, meals(starts_at)")
      .gte("meals.starts_at", start)
      .lt("meals.starts_at", end);

    if (error) return;

    const already = new Set((data||[]).map(r => r.member_id));
    const dupIds = [...selectedHostIds].filter(id => already.has(id));
    if (!dupIds.length) return;

    const names = dupIds.map(id => members.find(m => m.id === id)?.full_name).filter(Boolean).join("ØŒ ");
    dupWarn.textContent = `ØªÙ†Ø¨ÙŠÙ‡: Ø³Ø¨Ù‚ Ø¥Ø¶Ø§ÙØ© ${names} ÙƒØ¯Ø§Ø¹ÙŠ/Ø¯Ø§Ø¹ÙŠÙ† Ø®Ù„Ø§Ù„ Ù†ÙØ³ Ø§Ù„Ø´Ù‡Ø±. (Ù„Ø§ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸)`;
    dupWarn.style.display = "block";
  }

  async function addMember(){
    const name = (newMemberEl.value || "").trim();
    if (!name) return;
    const { error } = await supabase.from("members").insert({ full_name: name });
    if (error) alert(error.message);
    newMemberEl.value = "";
    await loadMembers();
  }

  function resetForm(){
    editingMealId = null;
    selectedHostIds = new Set();
    mealTypeEl.value = "asha";
    notesEl.value = "";
    deleteMealBtn.style.display = "none";
    editNote.textContent = "";
    renderHostsPicker();
    updateDuplicateWarning();
  }

  async function saveMeal(){
    const d = dateEl.value;
    if (!d){ alert("Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®"); return; }
    const { startISO, endISO } = computeEndISO(d, startTimeEl.value, endTimeEl.value);
    if (new Date(endISO) <= new Date(startISO)){ alert("ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"); return; }
    if (selectedHostIds.size === 0){
      if (!confirm("Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¯Ø§Ø¹ÙŠÙ†. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­ÙØ¸ Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¹ÙŠÙ†ØŸ")) return;
    }

    const payload = {
      meal: mealTypeEl.value,
      starts_at: startISO,
      ends_at: endISO,
      notes: (notesEl.value || "").trim() || null
    };

    let mealId = editingMealId;
    if (editingMealId){
      const { error } = await supabase.from("meals").update(payload).eq("id", editingMealId);
      if (error){ alert(error.message); return; }
      editNote.innerHTML = "<b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù„Ø§ ÙŠØ­Ø¯Ù‘Ø« ØªÙ‚Ø§ÙˆÙŠÙ… Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. ÙŠÙÙØ¶Ù‘Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ØªØ¹Ø¯ÙŠÙ„.";
    } else {
      const { data, error } = await supabase.from("meals").insert(payload).select("id").single();
      if (error){ alert(error.message); return; }
      mealId = data.id;
      editNote.textContent = "";
    }

    await supabase.from("meal_hosts").delete().eq("meal_id", mealId);
    if (selectedHostIds.size){
      const rows = [...selectedHostIds].map(member_id => ({ meal_id: mealId, member_id }));
      const { error } = await supabase.from("meal_hosts").insert(rows);
      if (error){ alert(error.message); return; }
    }

    setStatus("ok", "ØªÙ… Ø§Ù„Ø­ÙØ¸.");
    await loadMonthTable();
    editingMealId = mealId;
    deleteMealBtn.style.display = "inline-flex";
  }

  async function deleteMeal(){
    if (!editingMealId) return;
    if (!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©ØŸ")) return;
    const { error } = await supabase.from("meals").delete().eq("id", editingMealId);
    if (error){ alert(error.message); return; }
    setStatus("ok", "ØªÙ… Ø§Ù„Ø­Ø°Ù.");
    resetForm();
    await loadMonthTable();
  }

  function buildMonthLink(month){
    const base = window.location.origin + window.location.pathname.replace("admin.html","schedule.html");
    return `${base}?month=${month}&access=${encodeURIComponent(ACCESS_TOKEN)}`;
  }

  async function loadMonthTable(){
    const month = monthPick.value || getMonthParam();
    monthPick.value = month;

    const start = `${month}-01T00:00:00+03:00`;
    const [yy, mm] = month.split("-").map(Number);
    const endDate = new Date(Date.UTC(yy, mm, 1, 0, 0, 0));
    const end = `${endDate.getUTCFullYear()}-${String(endDate.getUTCMonth()+1).padStart(2,'0')}-${String(endDate.getUTCDate()).padStart(2,'0')}T00:00:00+03:00`;

    const { data: meals, error } = await supabase
      .from("meals")
      .select("id, meal, starts_at, ends_at, notes, meal_hosts(member_id)")
      .gte("starts_at", start)
      .lt("starts_at", end)
      .order("starts_at", { ascending: true });

    if (error){
      monthTableWrap.textContent = error.message;
      return;
    }

    const table = el("table", { class:"table" }, []);
    table.appendChild(el("thead", {}, [
      el("tr", {}, [
        el("th", {}, ["Ø§Ù„Ù†ÙˆØ¹"]),
        el("th", {}, ["Ø§Ù„ØªØ§Ø±ÙŠØ®"]),
        el("th", {}, ["Ø§Ù„ÙˆÙ‚Øª"]),
        el("th", {}, ["Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†"]),
        el("th", {}, ["Ù…Ù„Ø§Ø­Ø¸Ø§Øª"]),
      ])
    ]));

    const tbody = el("tbody", {}, []);
    (meals||[]).forEach(r => {
      const hostIds = (r.meal_hosts || []).map(x => x.member_id);
      const hostNames = hostIds.map(id => members.find(m => m.id === id)?.full_name).filter(Boolean);

      const tr = el("tr", { style:"cursor:pointer", onclick: async () => {
        editingMealId = r.id;
        deleteMealBtn.style.display = "inline-flex";
        mealTypeEl.value = r.meal;

        const s = new Date(r.starts_at);
        const e = new Date(r.ends_at);

        const partsS = new Intl.DateTimeFormat("en-CA", { timeZone:"Asia/Riyadh", year:"numeric", month:"2-digit", day:"2-digit" }).format(s);
        dateEl.value = partsS;

        const timeS = new Intl.DateTimeFormat("en-GB", { timeZone:"Asia/Riyadh", hour:"2-digit", minute:"2-digit", hour12:false }).format(s);
        const timeE = new Intl.DateTimeFormat("en-GB", { timeZone:"Asia/Riyadh", hour:"2-digit", minute:"2-digit", hour12:false }).format(e);
        startTimeEl.value = timeS;
        endTimeEl.value = timeE;

        notesEl.value = r.notes || "";
        selectedHostIds = new Set(hostIds);
        renderHostsPicker();
        await updateDuplicateWarning();
        editNote.textContent = "ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ø­ÙØ¸ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø«Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø£Ø±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.";

        // Ø£ÙØ¶Ù„ Ù„Ù„Ø¬ÙˆØ§Ù„: Ø§ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ "Ù…Ù†Ø§Ø³Ø¨Ø©"
        setActiveTab("mealSec");
      }}, [
        el("td", {}, [mealLabel(r.meal)]),
        el("td", {}, [
          el("div", {}, [formatGregorian(r.starts_at)]),
          el("div", { class:"small" }, [formatHijriUmmAlQura(r.starts_at)])
        ]),
        el("td", {}, [`${formatTime12(r.starts_at)} â€“ ${formatTime12(r.ends_at)}`]),
        el("td", {}, [hostNames.join(" â€“ ") || "â€”"]),
        el("td", {}, [r.notes || "â€”"]),
      ]);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    monthTableWrap.innerHTML = "";
    monthTableWrap.appendChild(table);

    waPublishBtn.textContent = `ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨ (${monthLabel(month)})`;
  }

  function publishWhatsApp(){
    const month = monthPick.value || getMonthParam();
    const link = buildMonthLink(month);
    const msg =
`ğŸ“… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ ${APP_TITLE}
${monthLabel(month)}

Ø§ÙØªØ­ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø¶ØºØ· (Ø£Ø¶Ù Ù„Ù„ØªÙ‚ÙˆÙŠÙ…) Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ø³Ø¨ØªÙƒ:
${link}`;
    window.open(waLink(msg), "_blank");
  }

  logoutBtn.addEventListener("click", async () => {
    await supabase.auth.signOut();
    location.href = "./login.html";
  });

  addMemberBtn.addEventListener("click", addMember);
  newMemberEl.addEventListener("keydown", (e) => { if (e.key === "Enter") addMember(); });

  resetFormBtn.addEventListener("click", resetForm);
  saveMealBtn.addEventListener("click", saveMeal);
  deleteMealBtn.addEventListener("click", deleteMeal);

  reloadMonthBtn.addEventListener("click", loadMonthTable);
  monthPick.addEventListener("change", loadMonthTable);
  waPublishBtn.addEventListener("click", publishWhatsApp);

  dateEl.addEventListener("change", updateDuplicateWarning);

  (async () => {
    const user = await requireAdmin();
    if (!user) return;

    const today = new Date();
    dateEl.value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;

    const month = getMonthParam();
    monthPick.value = month;

    await loadMembers();
    await loadMonthTable();
    resetForm();

    // Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ø§ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ (ÙØ¹Ø§Ù„ Ø£ØµÙ„Ø§Ù‹)
    setActiveTab("membersSec");
  })();
</script>
</body>
</html>
