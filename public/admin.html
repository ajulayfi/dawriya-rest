<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” Ø¯ÙˆØ±ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</title>

  <link rel="stylesheet" href="./assets/app.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .notice{padding:10px 12px;border-radius:14px;background:#fff;border:1px solid var(--line,#e5e7eb)}
    .notice.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.06)}
    .notice.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.06)}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line,#e5e7eb);background:#fff;font-size:12px;color:var(--muted,#64748b)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;background:#111827;color:#fff}
    .btn.secondary{background:#fff;color:#111827;border:1px solid var(--line,#e5e7eb)}
    .btn.danger{background:#ef4444}
    .input{border:1px solid var(--line,#e5e7eb);border-radius:12px;padding:10px 12px;background:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:980px){.row{grid-template-columns:1fr}}
    .card{border:1px solid var(--line,#e5e7eb);border-radius:16px;background:#fff;padding:12px}
    .hr{height:1px;background:var(--line,#e5e7eb);margin:12px 0}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .small{color:var(--muted,#64748b);font-size:13px;line-height:1.6}
    .table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border:1px solid var(--line,#e5e7eb);border-radius:14px}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--line,#e5e7eb);text-align:right;vertical-align:top}
    .table thead th{background:#f8fafc;font-weight:900}
    .table tr:last-child td{border-bottom:none}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line,#e5e7eb);background:#fff}
    label{display:block;margin:10px 0 6px;font-weight:800}
  </style>
</head>

<body>
<div class="container">

  <div class="header">
    <div class="title">
      <h1 id="title">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      <div class="small">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ + Ø¬Ø¯ÙˆÙ„Ø© Ø´Ù‡Ø±ÙŠØ© + Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨</div>
    </div>
    <div class="toolbar">
      <span id="who" class="badge">â€”</span>
      <button id="logout" class="btn secondary">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div id="status" class="notice">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚â€¦</div>

  <div class="row" style="margin-top:12px">
    <!-- Members -->
    <div class="card">
      <div style="font-weight:900">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</div>
      <div class="small">Ø£Ø¶Ù/ÙØ¹Ù‘Ù„/Ø£ÙˆÙ‚Ù Ø£Ø¹Ø¶Ø§Ø¡</div>

      <label>Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ</label>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <input id="newMember" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ" style="flex:1 1 220px"/>
        <button id="addMember" class="btn">Ø¥Ø¶Ø§ÙØ©</button>
      </div>

      <div class="hr"></div>
      <div id="membersList" class="small">â€”</div>
    </div>

    <!-- Meal editor -->
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:900">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø§Ø³Ø¨Ø©</div>
          <div class="small">Ø§Ù„ÙˆÙ‚Øª ÙŠØ¯Ø¹Ù… Ø¹Ø¨ÙˆØ± Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ (Ù…Ø«Ø§Ù„: Ø¥Ù„Ù‰ 00:30).</div>
        </div>
        <span class="badge">Ø§Ù„Ù…ÙƒØ§Ù†: <b style="color:#111827" id="loc">â€”</b></span>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <label>Ø§Ù„Ù†ÙˆØ¹</label>
          <select id="mealType" class="input">
            <option value="futoor">ÙØ·ÙˆØ±</option>
            <option value="ghada">ØºØ¯Ø§</option>
            <option value="asha">Ø¹Ø´Ø§</option>
            <option value="suhoor">Ø³Ø­ÙˆØ±</option>
          </select>
        </div>
        <div>
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…ÙŠÙ„Ø§Ø¯ÙŠ)</label>
          <input id="date" class="input" type="date"/>
        </div>
        <div>
          <label>Ù…Ù†</label>
          <input id="startTime" class="input" type="time" value="19:00"/>
        </div>
        <div>
          <label>Ø¥Ù„Ù‰</label>
          <input id="endTime" class="input" type="time" value="00:00"/>
        </div>
      </div>

      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <textarea id="notes" class="input" rows="2" placeholder="Ù…Ø«Ø§Ù„: ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙŠØ¬ÙŠØ¨ Ø´ÙŠØ¡..."></textarea>

      <div class="hr"></div>

      <div style="font-weight:900;margin-bottom:6px">Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†</div>
      <div id="hostsPicker" class="small">â€”</div>

      <div class="hr"></div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="saveMeal" class="btn">Ø­ÙØ¸</button>
          <button id="resetForm" class="btn secondary">ØªÙØ±ÙŠØº</button>
          <button id="deleteMeal" class="btn danger" style="display:none">Ø­Ø°Ù</button>
        </div>
        <button id="waPublish" class="btn secondary">ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨ (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</button>
      </div>

      <div id="editNote" class="small" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Month table -->
  <div class="card" style="margin-top:12px">
    <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-weight:900">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±</div>
        <div class="small">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ØµÙ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <input id="monthPick" class="input" type="month"/>
        <button id="reloadMonth" class="btn secondary">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="monthTableWrap">â€”</div>
  </div>

</div>

<script type="module">
  import { SUPABASE_URL, SUPABASE_ANON_KEY, ACCESS_TOKEN, TZ, DEFAULT_LOCATION, APP_TITLE } from "./assets/config.js";

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  window.sb = sb; // Ù„Ù„ØªØ´Ø®ÙŠØµ Ø¹Ø¨Ø± Console

  const el = (tag, attrs={}, children=[]) => {
    const n = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)){
      if (k === "class") n.className = v;
      else if (k === "onclick") n.addEventListener("click", v);
      else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
      else n.setAttribute(k, v);
    }
    children.forEach(c => n.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
    return n;
  };
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2,"0");

  $("title").textContent = `Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” ${APP_TITLE}`;
  $("loc").textContent = DEFAULT_LOCATION;

  const statusEl = $("status");
  const whoEl = $("who");

  const newMemberEl = $("newMember");
  const addMemberBtn = $("addMember");
  const membersList = $("membersList");

  const mealTypeEl = $("mealType");
  const dateEl = $("date");
  const startTimeEl = $("startTime");
  const endTimeEl = $("endTime");
  const notesEl = $("notes");
  const hostsPicker = $("hostsPicker");

  const saveMealBtn = $("saveMeal");
  const resetFormBtn = $("resetForm");
  const deleteMealBtn = $("deleteMeal");
  const editNote = $("editNote");

  const monthPick = $("monthPick");
  const reloadMonthBtn = $("reloadMonth");
  const monthTableWrap = $("monthTableWrap");
  const waPublishBtn = $("waPublish");
  const logoutBtn = $("logout");

  let members = [];
  let editingMealId = null;
  let selectedHostIds = new Set();

  function setStatus(kind, text){
    statusEl.className = kind ? `notice ${kind}` : "notice";
    statusEl.textContent = text;
  }

  function mealLabel(key){
    return ({ futoor:"ÙØ·ÙˆØ±", ghada:"ØºØ¯Ø§", asha:"Ø¹Ø´Ø§", suhoor:"Ø³Ø­ÙˆØ±" }[key] || key);
  }

  function monthLabel(month){
    const [y, m] = month.split("-").map(Number);
    const d = new Date(Date.UTC(y, m-1, 1, 12, 0, 0));
    return new Intl.DateTimeFormat("ar-SA", { year:"numeric", month:"long", timeZone: TZ }).format(d);
  }

  function formatGregorian(iso){
    const d = new Date(iso);
    const weekday = new Intl.DateTimeFormat("ar-SA", { weekday:"long", timeZone: TZ }).format(d);
    const ymd = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" }).format(d);
    const [y,m,da] = ymd.split("-");
    return `${weekday} ${da}/${m}/${y}`;
  }

  function formatHijri(iso){
    const d = new Date(iso);
    try{
      const h = new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura", { year:"numeric", month:"long", day:"numeric", timeZone: TZ }).format(d);
      return "Ø§Ù„Ù…ÙˆØ§ÙÙ‚ " + h;
    }catch(e){
      return "Ø§Ù„Ù…ÙˆØ§ÙÙ‚ â€”";
    }
  }

  function formatTime12(iso){
    const d = new Date(iso);
    return new Intl.DateTimeFormat("ar-SA", { hour:"numeric", minute:"2-digit", hour12:true, timeZone: TZ }).format(d);
  }

  function getMonthParam(){
    const u = new URL(location.href);
    const m = u.searchParams.get("month");
    if (m && /^\\d{4}-\\d{2}$/.test(m)) return m;
    const d = new Date();
    return d.getFullYear() + "-" + pad2(d.getMonth()+1);
  }

  function computeEndISO(dateYYYYMMDD, startHHMM, endHHMM){
    // Ù†Ø¨Ù†ÙŠ ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø±ÙŠØ§Ø¶ Ø«Ù… Ù†Ø®Ø²Ù†Ù‡ ÙƒÙ†Øµ ISO Ù…Ø¹ offset +03:00
    // (Supabase Ø³ÙŠØ³Ø¬Ù„Ù‡ ÙƒÙ€ timestamptz)
    const startISO = `${dateYYYYMMDD}T${startHHMM}:00+03:00`;
    let endISO = `${dateYYYYMMDD}T${endHHMM}:00+03:00`;

    // Ø¹Ø¨ÙˆØ± Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„
    const s = new Date(startISO);
    let e = new Date(endISO);
    if (e <= s){
      e = new Date(e.getTime() + 24*60*60*1000);
      const y = e.getUTCFullYear();
      const mo = pad2(e.getUTCMonth()+1);
      const da = pad2(e.getUTCDate());
      const hh = pad2(e.getUTCHours());
      const mm = pad2(e.getUTCMinutes());
      // Ù†Ø¹ÙŠØ¯Ù‡ ÙƒÙ†Øµ +03:00 (Ù…Ù‡Ù…)
      endISO = `${y}-${mo}-${da}T${hh}:${mm}:00+03:00`;
    }
    return { startISO, endISO };
  }

  function waLink(text){
    return "https://wa.me/?text=" + encodeURIComponent(text);
  }

  function buildMonthLink(month){
    const base = window.location.origin + window.location.pathname.replace("admin.html","schedule.html");
    return `${base}?month=${month}&access=${encodeURIComponent(ACCESS_TOKEN)}`;
  }

  async function requireAdmin(){
    const { data: { user } } = await sb.auth.getUser();
    if (!user){
      location.href = "./login.html";
      return null;
    }
    whoEl.textContent = user.email || user.id;

    const { data, error } = await sb.rpc("is_admin");
    if (error || !data){
      setStatus("warn", "ØºÙŠØ± Ù…ØµØ±Ø­. ØªØ£ÙƒØ¯ Ø£Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø¶Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙŠ Supabase.");
      return null;
    }
    setStatus("ok", "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.");
    return user;
  }

  async function loadMembers(){
    const { data, error } = await sb
      .from("members")
      .select("id, full_name, is_active")
      .order("full_name", { ascending: true });

    if (error){
      membersList.textContent = error.message;
      hostsPicker.textContent = "â€”";
      return;
    }
    members = data || [];
    renderMembers();
    renderHostsPicker();
  }

  function renderMembers(){
    if (!members.length){
      membersList.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø¹Ø¯.";
      return;
    }
    const wrap = el("div", {}, []);
    members.forEach(m => {
      const line = el("div", { style:"display:flex;gap:10px;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px dashed var(--line,#e5e7eb)" }, [
        el("div", {}, [
          el("div", { style:"font-weight:900" }, [m.full_name]),
          el("div", { class:"small" }, [m.is_active ? "Ù…ÙØ¹Ù‘Ù„" : "Ù…ÙˆÙ‚ÙˆÙ"])
        ]),
        el("button", {
          class:"btn secondary",
          onclick: async () => {
            const { error } = await sb.from("members").update({ is_active: !m.is_active }).eq("id", m.id);
            if (error) alert(error.message);
            await loadMembers();
          }
        }, [m.is_active ? "Ø¥ÙŠÙ‚Ø§Ù" : "ØªÙØ¹ÙŠÙ„"])
      ]);
      wrap.appendChild(line);
    });
    membersList.innerHTML = "";
    membersList.appendChild(wrap);
  }

  function renderHostsPicker(){
    const active = members.filter(m => !!m.is_active);
    if (!active.length){
      hostsPicker.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ù…ÙØ¹Ù‘Ù„ÙŠÙ†. ÙØ¹Ù‘Ù„ Ø¹Ø¶Ùˆ Ø£ÙˆÙ„Ø§Ù‹.";
      return;
    }
    const wrap = el("div", { style:"display:flex;flex-wrap:wrap;gap:10px" }, []);
    active.forEach(m => {
      const id = `host_${m.id}`;
      const cb = el("input", {
        type:"checkbox",
        id,
        onchange: (e) => {
          if (e.target.checked) selectedHostIds.add(m.id);
          else selectedHostIds.delete(m.id);
        }
      });
      cb.checked = selectedHostIds.has(m.id);

      wrap.appendChild(
        el("label", { for:id, class:"pill", style:"cursor:pointer" }, [
          cb, el("span", {}, [m.full_name])
        ])
      );
    });
    hostsPicker.innerHTML = "";
    hostsPicker.appendChild(wrap);
  }

  async function addMember(){
    const name = (newMemberEl.value || "").trim();
    if (!name) return;
    const { error } = await sb.from("members").insert({ full_name: name, is_active: true });
    if (error) alert(error.message);
    newMemberEl.value = "";
    await loadMembers();
  }

  function resetForm(){
    editingMealId = null;
    selectedHostIds = new Set();
    mealTypeEl.value = "asha";
    notesEl.value = "";
    deleteMealBtn.style.display = "none";
    editNote.textContent = "";
    renderHostsPicker();
  }

  async function saveMeal(){
    const d = dateEl.value;
    if (!d){ alert("Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®"); return; }

    const { startISO, endISO } = computeEndISO(d, startTimeEl.value, endTimeEl.value);
    if (new Date(endISO) <= new Date(startISO)){
      alert("ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©");
      return;
    }

    if (selectedHostIds.size === 0){
      if (!confirm("Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¯Ø§Ø¹ÙŠÙ†. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­ÙØ¸ Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¹ÙŠÙ†ØŸ")) return;
    }

    const payload = {
      meal: mealTypeEl.value,
      starts_at: startISO,
      ends_at: endISO,
      notes: (notesEl.value || "").trim() || null
    };

    let mealId = editingMealId;

    if (editingMealId){
      const upd = await sb.from("meals").update(payload).eq("id", editingMealId);
      console.log("[meals] update:", upd);
      if (upd.error){ alert(upd.error.message); return; }
      editNote.innerHTML = "<b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù„Ø§ ÙŠØ­Ø¯Ù‘Ø« ØªÙ‚Ø§ÙˆÙŠÙ… Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. ÙŠÙÙØ¶Ù‘Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ØªØ¹Ø¯ÙŠÙ„.";
    } else {
      const ins = await sb.from("meals").insert(payload).select("id").single();
      console.log("[meals] insert:", ins);
      if (ins.error){ alert(ins.error.message); return; }
      mealId = ins.data.id;
      editNote.textContent = "";
    }

    // âœ… ØªØ­Ø¯ÙŠØ« Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ† (meal_hosts) â€” Ù…Ø¹ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¨ÙˆØ¶ÙˆØ­
    const delRes = await sb.from("meal_hosts").delete().eq("meal_id", mealId);
    console.log("[meal_hosts] delete:", delRes);
    if (delRes.error){
      alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ† (Ø­Ø°Ù Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©): " + delRes.error.message);
      return;
    }

    if (selectedHostIds.size){
      const rows = [...selectedHostIds].map(member_id => ({ meal_id: mealId, member_id }));
      console.log("[meal_hosts] insert rows:", rows);

      const insRes = await sb.from("meal_hosts").insert(rows);
      console.log("[meal_hosts] insert:", insRes);

      if (insRes.error){
        alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ† (Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ÙˆØ§Ø¨Ø·): " + insRes.error.message);
        return;
      }
    }

    setStatus("ok", "ØªÙ… Ø§Ù„Ø­ÙØ¸.");
    await loadMonthTable();
    editingMealId = mealId;
    deleteMealBtn.style.display = "inline-flex";
  }

  async function deleteMeal(){
    if (!editingMealId) return;
    if (!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©ØŸ")) return;
    const res = await sb.from("meals").delete().eq("id", editingMealId);
    console.log("[meals] delete:", res);
    if (res.error){ alert(res.error.message); return; }
    setStatus("ok", "ØªÙ… Ø§Ù„Ø­Ø°Ù.");
    resetForm();
    await loadMonthTable();
  }

  async function loadMonthTable(){
    const month = monthPick.value || getMonthParam();
    monthPick.value = month;

    const start = `${month}-01T00:00:00+03:00`;
    const [yy, mm] = month.split("-").map(Number);
    const endDate = new Date(Date.UTC(yy, mm, 1, 0, 0, 0));
    const end = `${endDate.getUTCFullYear()}-${pad2(endDate.getUTCMonth()+1)}-${pad2(endDate.getUTCDate())}T00:00:00+03:00`;

    const res = await sb
      .from("meals")
      .select("id, meal, starts_at, ends_at, notes, meal_hosts(member_id)")
      .gte("starts_at", start)
      .lt("starts_at", end)
      .order("starts_at", { ascending: true });

    console.log("[meals] month query:", res);

    if (res.error){
      monthTableWrap.textContent = res.error.message;
      return;
    }

    const meals = res.data || [];

    const table = el("table", { class:"table" }, []);
    table.appendChild(el("thead", {}, [
      el("tr", {}, [
        el("th", {}, ["Ø§Ù„Ù†ÙˆØ¹"]),
        el("th", {}, ["Ø§Ù„ØªØ§Ø±ÙŠØ®"]),
        el("th", {}, ["Ø§Ù„ÙˆÙ‚Øª"]),
        el("th", {}, ["Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†"]),
        el("th", {}, ["Ù…Ù„Ø§Ø­Ø¸Ø§Øª"]),
      ])
    ]));

    const tbody = el("tbody", {}, []);

    meals.forEach(r => {
      const hostIds = (r.meal_hosts || []).map(x => x.member_id);
      const hostNames = hostIds.map(id => members.find(m => m.id === id)?.full_name).filter(Boolean);

      const tr = el("tr", { style:"cursor:pointer", onclick: async () => {
        editingMealId = r.id;
        deleteMealBtn.style.display = "inline-flex";

        mealTypeEl.value = r.meal;

        const s = new Date(r.starts_at);
        const e = new Date(r.ends_at);

        // ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø±ÙŠØ§Ø¶
        const dateStr = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" }).format(s);
        dateEl.value = dateStr;

        const timeS = new Intl.DateTimeFormat("en-GB", { timeZone: TZ, hour:"2-digit", minute:"2-digit", hour12:false }).format(s);
        const timeE = new Intl.DateTimeFormat("en-GB", { timeZone: TZ, hour:"2-digit", minute:"2-digit", hour12:false }).format(e);
        startTimeEl.value = timeS;
        endTimeEl.value = timeE;

        notesEl.value = r.notes || "";
        selectedHostIds = new Set(hostIds);
        renderHostsPicker();

        editNote.textContent = "ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¹Ø¯Ù‘Ù„ Ø«Ù… Ø§Ø­ÙØ¸. (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø£Ø±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.";
        window.scrollTo({ top: 0, behavior: "smooth" });
      }}, [
        el("td", {}, [mealLabel(r.meal)]),
        el("td", {}, [
          el("div", { style:"font-weight:900" }, [formatGregorian(r.starts_at)]),
          el("div", { class:"small" }, [formatHijri(r.starts_at)])
        ]),
        el("td", {}, [`${formatTime12(r.starts_at)} â€“ ${formatTime12(r.ends_at)}`]),
        el("td", {}, [hostNames.join(" â€“ ") || "â€”"]),
        el("td", {}, [r.notes || "â€”"]),
      ]);

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);

    monthTableWrap.innerHTML = "";
    monthTableWrap.appendChild(table);

    waPublishBtn.textContent = `ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨ (${monthLabel(month)})`;
  }

  function publishWhatsApp(){
    const month = monthPick.value || getMonthParam();
    const link = buildMonthLink(month);
    const msg =
`ğŸ“… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ ${APP_TITLE}
${monthLabel(month)}

Ø§ÙØªØ­ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø¶ØºØ· (Ø£Ø¶Ù Ù„Ù„ØªÙ‚ÙˆÙŠÙ…) Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ø³Ø¨ØªÙƒ:
${link}`;
    window.open(waLink(msg), "_blank");
  }

  logoutBtn.addEventListener("click", async () => {
    await sb.auth.signOut();
    location.href = "./login.html";
  });

  addMemberBtn.addEventListener("click", addMember);
  newMemberEl.addEventListener("keydown", (e) => { if (e.key === "Enter") addMember(); });

  resetFormBtn.addEventListener("click", resetForm);
  saveMealBtn.addEventListener("click", saveMeal);
  deleteMealBtn.addEventListener("click", deleteMeal);

  reloadMonthBtn.addEventListener("click", loadMonthTable);
  monthPick.addEventListener("change", loadMonthTable);
  waPublishBtn.addEventListener("click", publishWhatsApp);

  (async () => {
    const user = await requireAdmin();
    if (!user) return;

    const today = new Date();
    dateEl.value = `${today.getFullYear()}-${pad2(today.getMonth()+1)}-${pad2(today.getDate())}`;

    const month = getMonthParam();
    monthPick.value = month;

    await loadMembers();
    await loadMonthTable();
    resetForm();
  })();
</script>
</body>
</html>