<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
  <link rel="stylesheet" href="./assets/app.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¬ÙˆØ§Ù„ Ø®ÙÙŠÙØ© Ø¨Ø¯ÙˆÙ† ÙƒØ³Ø± CSS Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
    .kpis{display:grid;gap:10px;grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:900px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .kpi{padding:12px;border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg,#fff,rgba(255,255,255,.92))}
    .kpi b{font-size:18px}
    .kpi .small{margin-top:2px}
    .memberRow{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px dashed var(--line)}
    .memberName{font-weight:700}
    .memberMeta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:4px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .monthCards{display:grid;gap:10px}
    .monthCard{border:1px solid var(--line);border-radius:16px;background:#fff;padding:12px;cursor:pointer}
    .monthCard:hover{box-shadow:0 12px 30px rgba(0,0,0,.06)}
    .monthTop{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;align-items:flex-start}
    .monthTop .badge{white-space:nowrap}
    .monthCard .small{line-height:1.55}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      <div class="sub">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ + Ø¬Ø¯ÙˆÙ„Ø© Ø´Ù‡Ø±ÙŠØ© + Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨</div>
    </div>
    <div class="toolbar">
      <span id="who" class="badge">â€”</span>
      <button id="logout" class="btn secondary">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div id="status" class="notice">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚â€¦</div>

  <!-- Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹ -->
  <div class="card" style="margin-top:12px">
    <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-weight:700">Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</div>
        <div class="small">ÙŠØ¹Ø·ÙŠÙƒ ØµÙˆØ±Ø© Ø³Ø±ÙŠØ¹Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©.</div>
      </div>
      <span id="monthLabelTop" class="badge">â€”</span>
    </div>
    <div class="hr"></div>

    <div class="kpis">
      <div class="kpi">
        <div class="small">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ù…ÙØ¹Ù‘Ù„)</div>
        <b id="kpiActiveMembers">â€”</b>
      </div>
      <div class="kpi">
        <div class="small">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ)</div>
        <b id="kpiTotalMembers">â€”</b>
      </div>
      <div class="kpi">
        <div class="small">Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
        <b id="kpiMonthMeals">â€”</b>
      </div>
      <div class="kpi">
        <div class="small">Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
        <b id="kpiUpcoming">â€”</b>
      </div>
    </div>

    <div id="kpiNext" class="notice ok" style="margin-top:10px;display:none"></div>
  </div>

  <div class="row" style="margin-top:12px">
    <!-- Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ -->
    <div class="col">
      <div class="card">
        <div style="font-weight:700">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</div>
        <div class="small">Ø£Ø¶Ù/Ø¹Ø·Ù‘Ù„ Ø£Ø¹Ø¶Ø§Ø¡ â€” Ù…Ø¹ Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</div>

        <label>Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ</label>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <input id="newMember" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ" style="flex:1 1 220px"/>
          <button id="addMember" class="btn">Ø¥Ø¶Ø§ÙØ©</button>
        </div>

        <div class="hr"></div>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <input id="memberSearch" class="input" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡â€¦" style="flex:1 1 220px"/>
          <label class="pill" style="cursor:pointer">
            <input id="showInactive" type="checkbox" style="accent-color:var(--accent);margin-inline-end:6px"/>
            Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚ÙˆÙÙŠÙ†
          </label>
        </div>

        <div class="hr"></div>
        <div id="membersList" class="small">â€”</div>
      </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„Ø© -->
    <div class="col">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div>
            <div style="font-weight:700">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø§Ø³Ø¨Ø©</div>
            <div class="small">Ø§Ù„ØªØ§Ø±ÙŠØ® + (Ù…Ù† â†’ Ø¥Ù„Ù‰) ÙŠØ¯Ø¹Ù… Ø¹Ø¨ÙˆØ± Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„.</div>
          </div>
          <span class="badge">Ø§Ù„Ù…ÙƒØ§Ù†: <b style="color:#111827">Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</b></span>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Ø§Ù„Ù†ÙˆØ¹</label>
            <select id="mealType" class="input">
              <option value="futoor">ÙØ·ÙˆØ±</option>
              <option value="ghada">ØºØ¯Ø§</option>
              <option value="asha">Ø¹Ø´Ø§</option>
              <option value="suhoor">Ø³Ø­ÙˆØ±</option>
            </select>
          </div>
          <div>
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…ÙŠÙ„Ø§Ø¯ÙŠ)</label>
            <input id="date" class="input" type="date"/>
            <div id="hijriPreview" class="small muted" style="margin-top:6px">â€”</div>
          </div>
          <div>
            <label>Ù…Ù†</label>
            <input id="startTime" class="input" type="time" value="19:00"/>
          </div>
          <div>
            <label>Ø¥Ù„Ù‰</label>
            <input id="endTime" class="input" type="time" value="00:00"/>
          </div>
        </div>

        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <textarea id="notes" class="input" rows="2" placeholder="Ù…Ø«Ø§Ù„: ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙŠØ¬ÙŠØ¨ Ø´ÙŠØ¡..."></textarea>

        <div class="hr"></div>
        <div id="dupWarn" class="notice warn" style="display:none"></div>

        <div style="font-weight:700;margin:6px 0">Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†</div>
        <div id="hostsPicker" class="small">â€”</div>

        <div class="hr"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button id="saveMeal" class="btn">Ø­ÙØ¸</button>
            <button id="resetForm" class="btn secondary">ØªÙØ±ÙŠØº</button>
            <button id="deleteMeal" class="btn danger" style="display:none">Ø­Ø°Ù</button>
          </div>
          <button id="waPublish" class="btn secondary">ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨ (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</button>
        </div>

        <div id="editNote" class="small" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-weight:700">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±</div>
        <div class="small">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø©/ØµÙ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</div>
      </div>
      <div class="toolbar">
        <input id="monthPick" class="input" type="month"/>
        <button id="reloadMonth" class="btn secondary">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="monthTableWrap">â€”</div>
  </div>

</div>

<script type="module">
  import {
    supabase, setTitle, mealLabel, getMonthParam, monthLabel,
    computeEndISO, formatGregorian, formatHijriUmmAlQura, formatTime12,
    waLink, el
  } from "./assets/app.js";
  import { APP_TITLE } from "./assets/config.js";

  setTitle("Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©");

  const statusEl = document.getElementById("status");
  const whoEl = document.getElementById("who");
  const logoutBtn = document.getElementById("logout");

  const kpiActiveMembers = document.getElementById("kpiActiveMembers");
  const kpiTotalMembers = document.getElementById("kpiTotalMembers");
  const kpiMonthMeals = document.getElementById("kpiMonthMeals");
  const kpiUpcoming = document.getElementById("kpiUpcoming");
  const kpiNext = document.getElementById("kpiNext");
  const monthLabelTop = document.getElementById("monthLabelTop");

  const newMemberEl = document.getElementById("newMember");
  const addMemberBtn = document.getElementById("addMember");
  const memberSearch = document.getElementById("memberSearch");
  const showInactive = document.getElementById("showInactive");
  const membersList = document.getElementById("membersList");

  const mealTypeEl = document.getElementById("mealType");
  const dateEl = document.getElementById("date");
  const startTimeEl = document.getElementById("startTime");
  const endTimeEl = document.getElementById("endTime");
  const notesEl = document.getElementById("notes");
  const hijriPreview = document.getElementById("hijriPreview");
  const hostsPicker = document.getElementById("hostsPicker");
  const dupWarn = document.getElementById("dupWarn");

  const saveMealBtn = document.getElementById("saveMeal");
  const resetFormBtn = document.getElementById("resetForm");
  const deleteMealBtn = document.getElementById("deleteMeal");
  const editNote = document.getElementById("editNote");

  const monthPick = document.getElementById("monthPick");
  const reloadMonthBtn = document.getElementById("reloadMonth");
  const monthTableWrap = document.getElementById("monthTableWrap");
  const waPublishBtn = document.getElementById("waPublish");

  let members = [];
  let selectedHostIds = new Set();
  let editingMealId = null;

  function toast(kind, text){
    statusEl.className = kind ? ("notice " + kind) : "notice";
    statusEl.textContent = text;
  }

  async function requireAdmin(){
    const { data: { user } } = await supabase.auth.getUser();
    if (!user){
      location.href = "./login.html";
      return null;
    }
    whoEl.textContent = user.email || "â€”";
    toast("ok", "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
    return user;
  }

  function renderHijriPreview(){
    if (!dateEl.value){ hijriPreview.textContent = "â€”"; return; }
    const iso = dateEl.value + "T12:00:00+03:00";
    try{
      hijriPreview.textContent = "Ø§Ù„Ù…ÙˆØ§ÙÙ‚ " + formatHijriUmmAlQura(iso);
    }catch{
      hijriPreview.textContent = "â€”";
    }
  }

  async function loadMembers(){
    const { data, error } = await supabase
      .from("members")
      .select("id, full_name, is_active")
      .order("full_name", { ascending: true });

    if (error){
      membersList.textContent = error.message;
      hostsPicker.textContent = "â€”";
      return;
    }
    members = data || [];
    renderMembers();
    renderHostsPicker();
    updateKPIs();
  }

  function renderMembers(){
    const q = (memberSearch.value || "").trim().toLowerCase();
    const includeInactive = !!showInactive.checked;

    const list = members
      .filter(m => includeInactive ? true : m.is_active)
      .filter(m => q ? m.full_name.toLowerCase().includes(q) : true);

    if (!list.length){
      membersList.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.";
      return;
    }

    const wrap = el("div", {}, []);
    list.forEach(m => {
      const left = el("div", {}, [
        el("div", { class:"memberName" }, [m.full_name]),
        el("div", { class:"memberMeta" }, [
          el("span", { class:"pill" }, [m.is_active ? "âœ… Ù…ÙØ¹Ù‘Ù„" : "â›”ï¸ Ù…ÙˆÙ‚ÙˆÙ"])
        ])
      ]);

      const btn = el("button", {
        class:"btn secondary",
        onclick: async () => {
          const { error } = await supabase.from("members").update({ is_active: !m.is_active }).eq("id", m.id);
          if (error) return alert(error.message);
          await loadMembers();
        }
      }, [m.is_active ? "Ø¥ÙŠÙ‚Ø§Ù" : "ØªÙØ¹ÙŠÙ„"]);

      wrap.appendChild(el("div", { class:"memberRow" }, [left, btn]));
    });

    membersList.innerHTML = "";
    membersList.appendChild(wrap);
  }

  function renderHostsPicker(){
    const active = members.filter(m => m.is_active);
    if (!active.length){
      hostsPicker.textContent = "Ø£Ø¶Ù Ø£Ø¹Ø¶Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹.";
      return;
    }
    const wrap = el("div", { style:"display:flex;flex-wrap:wrap;gap:10px" }, []);
    active.forEach(m => {
      const checked = selectedHostIds.has(m.id);
      const chip = el("label", {
        class: "chip",
        style: "cursor:pointer;display:inline-flex;align-items:center;gap:8px"
      }, [
        el("input", {
          type:"checkbox",
          checked,
          onchange: (e) => {
            if (e.target.checked) selectedHostIds.add(m.id);
            else selectedHostIds.delete(m.id);
          }
        }),
        m.full_name
      ]);
      wrap.appendChild(chip);
    });
    hostsPicker.innerHTML = "";
    hostsPicker.appendChild(wrap);
  }

  function buildMonthLink(month){
    const base = new URL("./schedule.html", location.href);
    base.searchParams.set("month", month);
    return base.toString();
  }

  async function updateDuplicateWarning(){
    dupWarn.style.display = "none";
    const date = dateEl.value;
    if (!date) return;

    const month = date.slice(0,7);
    const start = month + "-01T00:00:00+03:00";
    const parts = month.split("-").map(Number);
    const yy = parts[0], mm = parts[1];
    const endDate = new Date(Date.UTC(yy, mm, 1, 0, 0, 0));
    const end = endDate.getUTCFullYear() + "-" + String(endDate.getUTCMonth()+1).padStart(2,"0") + "-" + String(endDate.getUTCDate()).padStart(2,"0") + "T00:00:00+03:00";

    const hostIds = Array.from(selectedHostIds);
    if (!hostIds.length) return;

    const { data, error } = await supabase
      .from("meals")
      .select("id, starts_at, meal_hosts(member_id)")
      .gte("starts_at", start)
      .lt("starts_at", end);

    if (error) return;

    const clashes = [];
    (data||[]).forEach(r=>{
      if (editingMealId && r.id === editingMealId) return;
      const ids = (r.meal_hosts||[]).map(x=>x.member_id);
      const overlap = hostIds.filter(id=>ids.includes(id));
      if (overlap.length){
        const names = overlap.map(id => members.find(m=>m.id===id)?.full_name).filter(Boolean);
        if (names.length) clashes.push({ when: r.starts_at, names });
      }
    });

    if (clashes.length){
      const parts2 = clashes.slice(0,3).map(c => "â€¢ " + formatGregorian(c.when) + ": " + c.names.join(" â€“ "));
      dupWarn.innerHTML = "ØªÙ†Ø¨ÙŠÙ‡: Ø¨Ø¹Ø¶ Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ† Ù…Ø¶Ø§ÙÙŠÙ† Ø¨Ø§Ù„ÙØ¹Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± (Ù„Ù† ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸):<br/>" + parts2.join("<br/>");
      dupWarn.style.display = "block";
    }
  }

  function resetForm(){
    editingMealId = null;
    deleteMealBtn.style.display = "none";
    notesEl.value = "";
    selectedHostIds = new Set();
    renderHostsPicker();
    editNote.textContent = "";
    dupWarn.style.display = "none";
    renderHijriPreview();
  }

  async function saveMeal(){
    const meal = mealTypeEl.value;
    const date = dateEl.value;
    const startTime = startTimeEl.value || "19:00";
    const endTime = endTimeEl.value || "00:00";
    if (!date) return alert("Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®.");

    const startsAt = date + "T" + startTime + ":00+03:00";
    const endsAt = computeEndISO(date, startTime, endTime);
    const notes = (notesEl.value || "").trim() || null;

    toast("", "Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸â€¦");

    let mealId = editingMealId;

    if (editingMealId){
      const { error } = await supabase
        .from("meals")
        .update({ meal, starts_at: startsAt, ends_at: endsAt, notes })
        .eq("id", editingMealId);

      if (error){ toast("warn", error.message); return; }
    } else {
      const { data, error } = await supabase
        .from("meals")
        .insert({ meal, starts_at: startsAt, ends_at: endsAt, notes })
        .select("id")
        .single();

      if (error){ toast("warn", error.message); return; }
      mealId = data.id;
    }

    await supabase.from("meal_hosts").delete().eq("meal_id", mealId);

    const hostRows = Array.from(selectedHostIds).map(member_id => ({ meal_id: mealId, member_id }));
    if (hostRows.length){
      const { error } = await supabase.from("meal_hosts").insert(hostRows);
      if (error){ toast("warn", error.message); return; }
    }

    toast("ok", "ØªÙ… Ø§Ù„Ø­ÙØ¸.");
    editNote.textContent = editingMealId ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯." : "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯.";
    await loadMonthTable();
    await updateDuplicateWarning();
  }

  async function deleteMeal(){
    if (!editingMealId) return;
    if (!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©ØŸ")) return;

    toast("", "Ø¬Ø§Ø±Ù Ø§Ù„Ø­Ø°Ùâ€¦");
    await supabase.from("meal_hosts").delete().eq("meal_id", editingMealId);
    const { error } = await supabase.from("meals").delete().eq("id", editingMealId);
    if (error){ toast("warn", error.message); return; }
    toast("ok", "ØªÙ… Ø§Ù„Ø­Ø°Ù.");
    resetForm();
    await loadMonthTable();
  }

  function updateKPIs(meals){
    const total = members.length;
    const active = members.filter(m=>m.is_active).length;
    kpiTotalMembers.textContent = total ? String(total) : "0";
    kpiActiveMembers.textContent = active ? String(active) : "0";

    if (!meals) return;

    const now = new Date();
    const upcoming = meals.filter(r => new Date(r.starts_at) >= now);
    kpiMonthMeals.textContent = String(meals.length);
    kpiUpcoming.textContent = String(upcoming.length);

    const next = upcoming.sort((a,b)=> new Date(a.starts_at)-new Date(b.starts_at))[0];
    if (next){
      kpiNext.style.display = "block";
      kpiNext.textContent =
        "â­ï¸ Ø§Ù„Ø£Ù‚Ø±Ø¨: " + mealLabel(next.meal) + " â€” " +
        formatGregorian(next.starts_at) + " (" +
        formatTime12(next.starts_at) + " â€“ " + formatTime12(next.ends_at) + ")";
    } else {
      kpiNext.style.display = "none";
    }
  }

  function isMobileView(){
    return window.matchMedia("(max-width: 820px)").matches;
  }

  async function loadMonthTable(){
    const month = monthPick.value || getMonthParam();
    monthPick.value = month;

    monthLabelTop.textContent = monthLabel(month);
    waPublishBtn.textContent = "ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨ (" + monthLabel(month) + ")";

    const start = month + "-01T00:00:00+03:00";
    const parts = month.split("-").map(Number);
    const yy = parts[0], mm = parts[1];
    const endDate = new Date(Date.UTC(yy, mm, 1, 0, 0, 0));
    const end = endDate.getFullYear() + "-" + String(endDate.getMonth()+1).padStart(2,"0") + "-" + String(endDate.getDate()).padStart(2,"0") + "T00:00:00+03:00";

    const { data: meals, error } = await supabase
      .from("meals")
      .select("id, meal, starts_at, ends_at, notes, meal_hosts(member_id)")
      .gte("starts_at", start)
      .lt("starts_at", end)
      .order("starts_at", { ascending: true });

    if (error){
      monthTableWrap.textContent = error.message;
      return;
    }

    const rows = meals || [];
    updateKPIs(rows);

    const hostNamesOf = (r) => {
      const ids = (r.meal_hosts || []).map(x => x.member_id);
      return ids.map(id => members.find(m => m.id === id)?.full_name).filter(Boolean);
    };

    const onEdit = async (r) => {
      editingMealId = r.id;
      deleteMealBtn.style.display = "inline-flex";
      mealTypeEl.value = r.meal;

      const s = new Date(r.starts_at);
      const e = new Date(r.ends_at);

      const partsS = new Intl.DateTimeFormat("en-CA", { timeZone:"Asia/Riyadh", year:"numeric", month:"2-digit", day:"2-digit" }).format(s);
      dateEl.value = partsS;

      const timeS = new Intl.DateTimeFormat("en-GB", { timeZone:"Asia/Riyadh", hour:"2-digit", minute:"2-digit", hour12:false }).format(s);
      const timeE = new Intl.DateTimeFormat("en-GB", { timeZone:"Asia/Riyadh", hour:"2-digit", minute:"2-digit", hour12:false }).format(e);
      startTimeEl.value = timeS;
      endTimeEl.value = timeE;

      notesEl.value = r.notes || "";
      const ids = (r.meal_hosts || []).map(x => x.member_id);
      selectedHostIds = new Set(ids);
      renderHostsPicker();
      renderHijriPreview();
      await updateDuplicateWarning();
      editNote.textContent = "ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ø­ÙØ¸ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø«Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø£Ø±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.";
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    monthTableWrap.innerHTML = "";

    if (isMobileView()){
      const wrap = el("div", { class:"monthCards" }, []);
      rows.forEach(r=>{
        const hostNames = hostNamesOf(r);
        const card = el("div", { class:"monthCard", onclick: () => onEdit(r) }, [
          el("div", { class:"monthTop" }, [
            el("span", { class:"badge" }, [mealLabel(r.meal)]),
            el("span", { class:"pill" }, [formatTime12(r.starts_at) + " â€“ " + formatTime12(r.ends_at)]),
          ]),
          el("div", { style:"margin-top:8px" }, [
            el("div", {}, [formatGregorian(r.starts_at)]),
            el("div", { class:"small muted" }, ["Ø§Ù„Ù…ÙˆØ§ÙÙ‚ " + formatHijriUmmAlQura(r.starts_at)]),
          ]),
          el("div", { class:"small", style:"margin-top:8px" }, [
            el("b", {}, ["Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†: "]),
            hostNames.join(" â€“ ") || "â€”"
          ]),
          el("div", { class:"small muted", style:"margin-top:6px" }, [r.notes || "â€”"])
        ]);
        wrap.appendChild(card);
      });
      monthTableWrap.appendChild(wrap);
    } else {
      const table = el("table", { class:"table" }, []);
      table.appendChild(el("thead", {}, [
        el("tr", {}, [
          el("th", {}, ["Ø§Ù„Ù†ÙˆØ¹"]),
          el("th", {}, ["Ø§Ù„ØªØ§Ø±ÙŠØ®"]),
          el("th", {}, ["Ø§Ù„ÙˆÙ‚Øª"]),
          el("th", {}, ["Ø§Ù„Ø¯Ø§Ø¹ÙŠÙ†"]),
          el("th", {}, ["Ù…Ù„Ø§Ø­Ø¸Ø§Øª"]),
        ])
      ]));

      const tbody = el("tbody", {}, []);
      rows.forEach(r=>{
        const hostNames = hostNamesOf(r);
        const tr = el("tr", { style:"cursor:pointer", onclick: () => onEdit(r) }, [
          el("td", {}, [mealLabel(r.meal)]),
          el("td", {}, [
            el("div", {}, [formatGregorian(r.starts_at)]),
            el("div", { class:"small" }, ["Ø§Ù„Ù…ÙˆØ§ÙÙ‚ " + formatHijriUmmAlQura(r.starts_at)])
          ]),
          el("td", {}, [formatTime12(r.starts_at) + " â€“ " + formatTime12(r.ends_at)]),
          el("td", {}, [hostNames.join(" â€“ ") || "â€”"]),
          el("td", {}, [r.notes || "â€”"]),
        ]);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      monthTableWrap.appendChild(table);
    }
  }

  function publishWhatsApp(){
    const month = monthPick.value || getMonthParam();
    const link = buildMonthLink(month);
    const msg =
      "ğŸ“… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ " + APP_TITLE + "\n" +
      monthLabel(month) + "\n\n" +
      "Ø§ÙØªØ­ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø¶ØºØ· (Ø£Ø¶Ù Ù„Ù„ØªÙ‚ÙˆÙŠÙ…) Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ø³Ø¨ØªÙƒ:\n" +
      link;

    window.open(waLink(msg), "_blank");
  }

  logoutBtn.addEventListener("click", async () => {
    await supabase.auth.signOut();
    location.href = "./login.html";
  });

  addMemberBtn.addEventListener("click", async () => {
    const name = (newMemberEl.value || "").trim();
    if (!name) return;
    const { error } = await supabase.from("members").insert({ full_name: name, is_active: true });
    if (error) return alert(error.message);
    newMemberEl.value = "";
    await loadMembers();
  });

  newMemberEl.addEventListener("keydown", (e) => { if (e.key === "Enter") addMemberBtn.click(); });

  memberSearch.addEventListener("input", renderMembers);
  showInactive.addEventListener("change", renderMembers);

  resetFormBtn.addEventListener("click", resetForm);
  saveMealBtn.addEventListener("click", saveMeal);
  deleteMealBtn.addEventListener("click", deleteMeal);

  reloadMonthBtn.addEventListener("click", loadMonthTable);
  monthPick.addEventListener("change", loadMonthTable);
  waPublishBtn.addEventListener("click", publishWhatsApp);

  dateEl.addEventListener("change", () => { renderHijriPreview(); updateDuplicateWarning(); });
  startTimeEl.addEventListener("change", updateDuplicateWarning);
  endTimeEl.addEventListener("change", updateDuplicateWarning);
  mealTypeEl.addEventListener("change", updateDuplicateWarning);

  (async () => {
    const user = await requireAdmin();
    if (!user) return;

    const today = new Date();
    dateEl.value = today.getFullYear() + "-" + String(today.getMonth()+1).padStart(2,"0") + "-" + String(today.getDate()).padStart(2,"0");
    renderHijriPreview();

    const month = getMonthParam();
    monthPick.value = month;
    monthLabelTop.textContent = monthLabel(month);

    await loadMembers();
    await loadMonthTable();
    resetForm();
  })();
</script>
</body>
</html>
